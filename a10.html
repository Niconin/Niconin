<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>AI Chess Final - Permanent Hint</title>
<link rel="stylesheet" href="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.css">
<style>
  /* --- åŸºæœ¬ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ --- */
  body { margin:0; font-family:'Helvetica Neue', sans-serif; background:linear-gradient(135deg, #1e3c72, #2a5298); height:100vh; display:flex; justify-content:center; align-items:center; overflow:hidden; }
  .box { background:rgba(255,255,255,0.95); padding:20px; border-radius:15px; box-shadow:0 20px 50px rgba(0,0,0,0.5); display:flex; gap:25px; max-width:900px; width:95%; height: 85vh; position:relative; box-sizing: border-box; }
  
  /* --- ç›¤é¢ãƒ»æƒ…å ±ã‚¨ãƒªã‚¢ --- */
  .board-section { flex: 2; display: flex; flex-direction: column; justify-content: center; }
  .board-wrap { border:8px solid #34495e; border-radius:4px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
  .info-section { flex: 1; display:flex; flex-direction:column; align-items:center; min-width:280px; overflow-y: auto; padding-right:5px; }
  
  /* --- ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ --- */
  .mascot { font-size:70px; background:#fff; width:100px; height:100px; border-radius:50%; display:flex; justify-content:center; align-items:center; border:5px solid #ccc; margin-bottom:15px; transition:all 0.3s; }
  .turn-w { border-color: #f1c40f; box-shadow: 0 0 20px rgba(241, 196, 15, 0.6); transform: scale(1.05); }
  .turn-b { border-color: #8e44ad; box-shadow: 0 0 20px rgba(142, 68, 173, 0.6); transform: scale(0.95); grayscale: 100%; }

  /* --- å¹ãå‡ºã— --- */
  .bubble { position:relative; background:#fff; border:3px solid #3498db; border-radius:12px; padding:15px; width:100%; box-sizing:border-box; margin-bottom:10px; min-height:80px; font-size:14px; line-height:1.5; flex-shrink: 0; }
  .bubble::after { content:''; position:absolute; top:-15px; left:50%; transform:translateX(-50%); border:10px solid transparent; border-bottom-color:#3498db; }

  /* --- ãƒ«ãƒ¼ãƒ«ãƒ¡ãƒ¢ --- */
  .rule-memo { background: #ecf0f1; padding: 10px; border-radius: 8px; font-size: 12px; color: #555; width: 100%; box-sizing: border-box; margin-bottom: 10px; border-left: 4px solid #95a5a6; }
  
  /* --- ãƒœã‚¿ãƒ³ --- */
  .btn-group { width: 100%; display: flex; flex-direction: column; gap: 10px; margin-top: auto; }
  .btn { border:none; padding:12px; border-radius:8px; font-weight:bold; cursor:pointer; width:100%; color: white; transition: 0.2s; }
  .btn-hint { background: #f39c12; } .btn-hint:hover { background: #d35400; }
  .btn-reset { background: #e74c3c; } .btn-reset:hover { background: #c0392b; }

  /* --- ãƒ¡ãƒ‹ãƒ¥ãƒ¼ --- */
  .overlay { position:absolute; top:0; left:0; width:100%; height:100%; background:rgba(30,60,114,0.98); z-index:100; display:flex; flex-direction:column; justify-content:center; align-items:center; color:#fff; border-radius:15px; transition: opacity 0.3s; }
  .hidden { display: none !important; opacity: 0; }
  .menu-btn { background:#f1c40f; color:#333; margin:10px; padding:15px 40px; border:none; border-radius:30px; font-size:18px; font-weight:bold; cursor:pointer; width: 220px; }

  /* --- ãƒã‚¹ç›®ã®ãƒã‚¤ãƒ©ã‚¤ãƒˆ --- */
  .highlight-move { box-shadow: inset 0 0 0 4px rgba(46, 204, 113, 0.6); border-radius: 50%; }
  .highlight-capture { box-shadow: inset 0 0 0 4px rgba(231, 76, 60, 0.8); background: rgba(231, 76, 60, 0.2); }
  
  /* ãƒ’ãƒ³ãƒˆç”¨ãƒã‚¤ãƒ©ã‚¤ãƒˆ (ç‚¹ç¯ã—ã£ã±ãªã—) */
  .highlight-hint { 
    background-color: rgba(255, 255, 0, 0.6) !important; 
    box-shadow: 0 0 15px #f1c40f;
  }

  @media(max-width:768px){ .box{ flex-direction:column; height: auto; overflow-y: scroll; } .info-section { order: -1; } .board-wrap { width: 100%; } }
</style>
</head>
<body>

<div class="box">
  <div id="menu" class="overlay">
    <h1>â™š AI Chess</h1>
    <a href="a115.html">Ver.1.1.5(æœ€æ–°)ã¸</a>
    <p>å¼·ã•ã‚’é¸ã‚“ã§ã­</p>
    <select id="level" style="padding:10px; margin:10px; font-size:16px; border-radius:5px;">
      <option value="0">ğŸŒ± åˆç´š (æ‰‹åŠ æ¸›)</option>
      <option value="1" selected>ğŸ¥ ä¸­ç´š (ãµã¤ã†)</option>
      <option value="2">ğŸ¦… ä¸Šç´š (ã¤ã‚ˆã„)</option>
      <option value="3">ğŸ‰ è¶…ç´š (æœ€å¼·)</option>
    </select>
    <button class="menu-btn" onclick="startGame('player')">ğŸ® è‡ªåˆ†ã§å¯¾æˆ¦</button>
    <button class="menu-btn" onclick="startGame('auto')">ğŸ“º è¦³æˆ¦ãƒ¢ãƒ¼ãƒ‰</button>
  </div>

  <div class="board-section">
    <div class="board-wrap"><div id="board" style="width:100%"></div></div>
  </div>

  <div class="info-section">
    <div class="mascot turn-w" id="face">ğŸ§™â€â™‚ï¸</div>
    <div id="status" style="font-weight:bold; margin-bottom:5px;">æº–å‚™å®Œäº†</div>
    <div class="bubble" id="msg">ãƒ¬ãƒ™ãƒ«ã‚’é¸ã‚“ã§ã‚¹ã‚¿ãƒ¼ãƒˆï¼</div>
    
    <div class="rule-memo">
      <b>ğŸ“ ãƒ«ãƒ¼ãƒ«ãƒ¡ãƒ¢</b><br>
      â™Ÿ ãƒãƒ¼ãƒ³: å‰ã¸ (æ•µã¯æ–œã‚)<br>
      â™œ ãƒ«ãƒ¼ã‚¯: ç¸¦æ¨ªãƒ“ãƒ¼ãƒ <br>
      â™ ãƒ“ã‚·ãƒ§ãƒƒãƒ—: æ–œã‚ãƒ“ãƒ¼ãƒ <br>
      â™ ãƒŠã‚¤ãƒˆ: Lå­—ã‚¸ãƒ£ãƒ³ãƒ—<br>
      â™› ã‚¯ã‚¤ãƒ¼ãƒ³: æœ€å¼·(ç¸¦æ¨ªæ–œã‚)<br>
      â™š ã‚­ãƒ³ã‚°: ç‹æ§˜(å–ã‚‰ã‚ŒãŸã‚‰è² ã‘)
    </div>

    <div class="btn-group">
      <button class="btn btn-hint" onclick="showHint()">ğŸ’¡ ãƒ’ãƒ³ãƒˆ</button>
      <button class="btn btn-reset" onclick="location.reload()">ğŸ  ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã¸</button>
    </div>
  </div>
</div>

<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script src="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"></script>

<script>
const game = new Chess();
let board = null, aiLevel = 1, isAuto = false, autoTimer = null;
const ui = { face: $('#face'), msg: $('#msg'), status: $('#status') };

const pieceTheme = p => {
  const c = p[0]=='w'?'#fff':'#000', s = p[0]=='w'?'#000':'#fff';
  const sym = {'P':'â™™','N':'â™˜','B':'â™—','R':'â™–','Q':'â™•','K':'â™”','p':'â™Ÿ','n':'â™','b':'â™','r':'â™œ','q':'â™›','k':'â™š'}[p[1]] || 'â™Ÿ';
  return 'data:image/svg+xml;charset=utf-8,' + encodeURIComponent(`<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 60 60"><text x="50%" y="58%" text-anchor="middle" dominant-baseline="middle" font-family="sans-serif" font-size="50" fill="${c}" stroke="${s}" stroke-width="1.5">${sym}</text></svg>`);
};

function startGame(mode) {
  isAuto = (mode === 'auto');
  aiLevel = parseInt($('#level').val());
  $('#menu').addClass('hidden');
  
  board = Chessboard('board', {
    draggable: !isAuto,
    position: 'start',
    pieceTheme: pieceTheme,
    onDragStart: onDragStart,
    onDrop: onDrop,
    onSnapEnd: () => board.position(game.fen()),
    onMouseoutSquare: removeHighlights // ãƒã‚¦ã‚¹ãŒå¤–ã‚Œã¦ã‚‚ãƒ’ãƒ³ãƒˆã¯æ¶ˆã•ãªã„ï¼ˆæ“ä½œé–‹å§‹æ™‚ã«æ¶ˆãˆã‚‹ï¼‰
  });
  
  $(window).resize(board.resize);
  updateBoardState(isAuto ? "è¦³æˆ¦ãƒ¢ãƒ¼ãƒ‰é–‹å§‹ï¼" : "å¯¾å±€é–‹å§‹ï¼ç™½ã®ç•ªã ã‚ˆã€‚", "ğŸ§™â€â™‚ï¸");
  if(isAuto) setTimeout(autoPlayLoop, 1000);
}

function onDragStart (source, piece) {
  if (game.game_over() || isAuto) return false;
  if (game.turn() === 'b' || piece.search(/^b/) !== -1) return false;
  const moves = game.moves({ square: source, verbose: true });
  if (moves.length === 0) return false;
  
  // ãƒ‰ãƒ©ãƒƒã‚°é–‹å§‹æ™‚ã«ã€ãƒ’ãƒ³ãƒˆã‚’å«ã‚€ã™ã¹ã¦ã®ãƒã‚¤ãƒ©ã‚¤ãƒˆã‚’æ¶ˆã™
  removeHighlights();
  
  moves.forEach(m => highlightSquare(m.to, m.flags.includes('c') ? 'highlight-capture' : 'highlight-move'));
}

function onDrop (source, target) {
  removeHighlights();
  const move = game.move({ from: source, to: target, promotion: 'q' });
  if (move === null) return 'snapback';
  updateBoardState(null);
  if (!game.game_over()) window.setTimeout(makeAiMove, 500);
}

function makeAiMove() {
  const moves = game.moves({ verbose: true });
  if (moves.length === 0) return;
  
  // è©•ä¾¡é–¢æ•°
  const scoreMove = m => (m.flags.includes('c') ? 10 : 0) + (m.san.includes('+') ? 5 : 0) + (['d4','e4'].includes(m.to) ? 2 : 0);
  moves.sort((a, b) => scoreMove(b) - scoreMove(a));
  
  // ãƒ¬ãƒ™ãƒ«åˆ¥ãƒ­ã‚¸ãƒƒã‚¯
  const randomness = [6, 3, 1, 0];
  const range = randomness[aiLevel];
  
  const idx = Math.floor(Math.random() * Math.min(moves.length, range + 1));
  game.move(moves[idx].san);
  board.position(game.fen());
  updateBoardState(null);
}

function autoPlayLoop() {
  if (game.game_over()) return;
  makeAiMove();
  if (!game.game_over()) autoTimer = setTimeout(autoPlayLoop, 1500);
}

// ã€ä¿®æ­£ã€‘ãƒ’ãƒ³ãƒˆæ©Ÿèƒ½ï¼šç‚¹ç¯ã—ã£ã±ãªã—ï¼ˆè‡ªå‹•æ¶ˆå»ãªã—ï¼‰
function showHint() {
  if(game.game_over()) return;
  const moves = game.moves({ verbose: true });
  const scoreMove = m => (m.flags.includes('c') ? 10 : 0) + (m.san.includes('+') ? 5 : 0) + (['d4','e4'].includes(m.to) ? 2 : 0);
  moves.sort((a, b) => scoreMove(b) - scoreMove(a));
  const hint = moves[0];
  if(!hint) { ui.msg.text("ãƒ’ãƒ³ãƒˆãŒå‡ºã›ãªã„ã‚ˆï¼"); return; }

  // æ—¢å­˜ã®ãƒã‚¤ãƒ©ã‚¤ãƒˆã‚’æ¶ˆã—ã¦ã‹ã‚‰æ–°ã—ã„ãƒ’ãƒ³ãƒˆã‚’è¡¨ç¤º
  removeHighlights();
  highlightSquare(hint.from, 'highlight-hint');
  highlightSquare(hint.to, 'highlight-hint');
  
  // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ã¿æ›´æ–°ã€‚setTimeoutã«ã‚ˆã‚‹å‰Šé™¤ã¯è¡Œã‚ãªã„ã€‚
  ui.msg.html(`ãƒ’ãƒ³ãƒˆ: <b style="color:#d35400">${hint.from}</b> ã‹ã‚‰ <b style="color:#d35400">${hint.to}</b> ãŒãŠã™ã™ã‚ï¼`);
}

function updateBoardState(customMsg, customFace) {
  const turn = game.turn() === 'w' ? 'ç™½' : 'é»’';
  ui.face.removeClass('turn-w turn-b').addClass(game.turn() === 'w' ? 'turn-w' : 'turn-b');
  let msg = customMsg || "";
  let face = customFace || (game.turn() === 'w' ? "ğŸ§™â€â™‚ï¸" : "ğŸ¤”");

  if (game.game_over()) {
    clearTimeout(autoTimer);
    if (game.in_checkmate()) { msg = `å‹è² ã‚ã‚Šï¼${game.turn() === 'w' ? 'é»’' : 'ç™½'}ã®å‹ã¡ï¼`; face = "ğŸ†"; }
    else { msg = "å¼•ãåˆ†ã‘ï¼"; face = "ğŸ¤"; }
  } else if (!msg) {
    const history = game.history({ verbose: true });
    const last = history[history.length - 1];
    if (game.in_check()) { msg = `ç‹æ‰‹ï¼${turn}ã®ç‹æ§˜ãŒãƒ”ãƒ³ãƒï¼`; face = "ğŸ˜±"; }
    else if (last && last.flags.includes('c')) { msg = `ãŠã£ã¨ï¼${turn === 'ç™½' ? 'é»’' : 'ç™½'}ãŒé§’ã‚’å–ã£ãŸï¼`; face = "âš”ï¸"; }
    else { msg = `${turn}ã®ç•ªã€‚æ¬¡ã¯ã©ã†ã™ã‚‹ï¼Ÿ`; }
  }
  ui.msg.html(msg); ui.face.text(face);
  ui.status.text(isAuto ? `è¦³æˆ¦ä¸­ (${turn})` : `${turn}ã®ç•ª`);
}

function highlightSquare(square, className) { $('#board .square-' + square).addClass(className); }
// ãƒ’ãƒ³ãƒˆã‚‚æ¶ˆã›ã‚‹ã‚ˆã†ã«ã‚»ãƒ¬ã‚¯ã‚¿ã«ã‚¯ãƒ©ã‚¹ã‚’å«ã‚ã¦ãŠã
function removeHighlights() { $('#board .square-55d63').removeClass('highlight-move highlight-capture highlight-hint'); }
</script>
</body>

</html>

