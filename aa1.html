<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover">

<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="AI Chess">
<meta name="theme-color" content="#134E5E">

<link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><rect width=%22100%22 height=%22100%22 fill=%22%23134E5E%22 rx=%2220%22/><text x=%2250%22 y=%2250%22 font-size=%2260%22 text-anchor=%22middle%22 dominant-baseline=%22central%22>â™š</text></svg>">
<link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><rect width=%22100%22 height=%22100%22 fill=%22%23134E5E%22 rx=%2220%22/><text x=%2250%22 y=%2250%22 font-size=%2260%22 text-anchor=%22middle%22 dominant-baseline=%22central%22>â™š</text></svg>">

<link rel="manifest" id="dynamic-manifest">

<title>AI Chess - Ultimate M Final Edition Ver.3.2.0</title>

<link rel="stylesheet" href="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.css">

<style>
  /* === å…¨ä½“è¨­å®š === */
  body {
    margin: 0;
    font-family: 'Helvetica Neue', Arial, sans-serif;
    background: linear-gradient(135deg, #134E5E, #71B280);
    min-height: 100vh;
    width: 100vw;
    display: flex;
    justify-content: center;
    align-items: center;
    color: #fff;
    overflow-x: hidden;
    overflow-y: auto;
    /* å…¨ä½“ã§ã®é¸æŠãƒ»ãƒ¡ãƒ‹ãƒ¥ãƒ¼ç¦æ­¢ */
    -webkit-user-select: none;
    -moz-user-select: none;
    -ms-user-select: none;
    user-select: none;
    -webkit-touch-callout: none; /* iOSé•·æŠ¼ã—ãƒ¡ãƒ‹ãƒ¥ãƒ¼ç„¡åŠ¹åŒ– */
  }

  /* === ç”»åƒï¼ˆé§’ï¼‰ã®é•·æŠ¼ã—ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’å¼·åŠ›ã«ç„¡åŠ¹åŒ– === */
  img {
    -webkit-touch-callout: none !important;
    pointer-events: auto; /* ãƒ‰ãƒ©ãƒƒã‚°æ“ä½œã¯è¨±å¯ */
  }

  /* === ãƒ¡ã‚¤ãƒ³ã®ã‚³ãƒ³ãƒ†ãƒŠãƒœãƒƒã‚¯ã‚¹ === */
  .box {
    background: rgba(255, 255, 255, 0.95);
    color: #333;
    padding: 15px;
    border-radius: 15px;
    box-shadow: 0 20px 50px rgba(0,0,0,0.5);
    display: flex;
    gap: 20px;
    max-width: 950px;
    width: 95%;
    min-height: 80vh; 
    position: relative;
    box-sizing: border-box;
  }

  /* === ç›¤é¢ã‚¨ãƒªã‚¢ === */
  .board-section {
    flex: 2;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
  }
  .board-wrap {
    border: 5px solid #2E7D32;
    border-radius: 4px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.4);
    width: 100%;
    max-width: 60vh;
    aspect-ratio: 1 / 1;
    position: relative;
    transition: box-shadow 0.3s, border-color 0.3s;
    touch-action: none; /* ãƒ–ãƒ©ã‚¦ã‚¶ã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ç­‰ã‚’ç„¡åŠ¹åŒ– */
  }
      
  #board {
    width: 100%;
    height: 100%;
    /* ç›¤é¢å†…ã§ã®é•·æŠ¼ã—ãƒ¡ãƒ‹ãƒ¥ãƒ¼ç„¡åŠ¹åŒ–ã®ãƒ€ãƒ¡æŠ¼ã— */
    -webkit-touch-callout: none;
    -webkit-user-select: none;
  }
  
  /* chessboard.jsãŒç”Ÿæˆã™ã‚‹imgã‚¿ã‚°ã¸ã®å¯¾ç­– */
  #board img {
      -webkit-touch-callout: none !important;
      -webkit-user-drag: none; /* ä¸€éƒ¨ã®ãƒ–ãƒ©ã‚¦ã‚¶ã§ã‚´ãƒ¼ã‚¹ãƒˆãŒå‡ºã‚‹ã®ã‚’é˜²ã */
  }

  .in-check-danger {
    border-color: #c0392b !important; 
    box-shadow: 0 0 25px rgba(192, 57, 43, 0.8) !important;
  }

  /* === æƒ…å ±ã‚¨ãƒªã‚¢ï¼ˆå³å´ï¼‰ === */
  .info-section {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 10px;
    justify-content: flex-start;
  }

  /* === ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚¢ã‚¤ã‚³ãƒ³ === */
  .mascot {
    font-size: 50px;
    background: #fff;
    width: 80px;
    height: 80px;
    border-radius: 50%;
    display: flex;
    justify-content: center;
    align-items: center;
    border: 4px solid #ccc;
    margin-bottom: 5px;
    flex-shrink: 0; 
    box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    transition: 0.3s;
  }
      
  .active-turn {
    border-color: #2ecc71 !important;
    box-shadow: 0 0 25px rgba(46, 204, 113, 1.0) !important;
    transform: scale(1.05);
  }

  /* === å½¢å‹¢åˆ¤æ–­ã‚²ãƒ¼ã‚¸ === */
  .eval-gauge-container {
    width: 100%;
    height: 8px;
    background: #555;
    margin-bottom: 10px;
    border-radius: 4px;
    overflow: hidden;
    display: flex;
    flex-shrink: 0;
  }
  .eval-bar-white { height: 100%; background: #2ecc71; width: 50%; transition: width 0.5s ease-out; }

  /* === å¹ãå‡ºã— === */
  .bubble {
    position: relative;
    background: #ecf0f1;
    color: #2c3e50;
    border-radius: 12px;
    padding: 10px;
    width: 100%;
    margin-bottom: 10px;
    min-height: 80px;
    font-size: 13px;
    box-sizing: border-box;
    border: 2px solid #bdc3c7;
    display: flex;
    align-items: center;
    justify-content: center;
    text-align: center;
    font-weight: bold;
    flex-shrink: 0;
  }
  .bubble::after {
    content: '';
    position: absolute;
    top: -12px;
    left: 50%;
    transform: translateX(-50%);
    border: 12px solid transparent;
    border-bottom-color: #bdc3c7;
  }
      
  /* === ãƒ«ãƒ¼ãƒ«èª¬æ˜ã‚¨ãƒªã‚¢ === */
  .sidebar-rules {
    width: 100%;
    background: #f9fbe7;
    border: 2px solid #c5e1a5;
    border-radius: 8px;
    padding: 10px;
    margin-bottom: 10px;
    font-size: 0.85em;
    color: #33691e;
    box-sizing: border-box;
    text-align: left;
    flex-grow: 1; 
    overflow-y: auto; 
    max-height: 350px; 
  }
  .sidebar-rules h4 { margin: 0 0 8px 0; border-bottom: 2px solid #aed581; padding-bottom: 2px; text-align: center;}
   
  .piece-rule {
    display: flex;
    align-items: center;
    margin-bottom: 6px;
    border-bottom: 1px dashed #dcedc8;
    padding-bottom: 4px;
  }
  .piece-icon {
    font-size: 1.5em;
    width: 30px;
    text-align: center;
    margin-right: 8px;
  }
  .piece-desc {
    font-size: 0.9em;
    line-height: 1.2;
  }
  .piece-name {
    font-weight: bold;
    color: #558b2f;
    display: block;
    font-size: 0.85em;
  }

  /* === ãƒœã‚¿ãƒ³é¡ === */
  .btn-group { 
    width: 100%; 
    display: flex; flex-direction: column; 
    gap: 5px; 
    margin-top: 5px; 
    flex-shrink: 0;
  }
  .btn {
    border: none; 
    padding: 10px; 
    border-radius: 6px; 
    font-weight: bold; 
    cursor: pointer; 
    width: 100%; 
    color: white; 
    transition: 0.2s; 
    font-size: 13px;
  }
  .btn-hint { background: #e67e22; } .btn-hint:hover { background: #d35400; }
  .btn-undo { background: #9b59b6; } .btn-undo:hover { background: #8e44ad; } 
  .btn-auto { background: #2ecc71; } .btn-auto:hover { background: #27ae60; }
  .btn-auto-active { background: #e74c3c !important; }
  .btn-retry { background: #3498db; } .btn-retry:hover { background: #2980b9; }
  .btn-reset { background: #95a5a6; } .btn-reset:hover { background: #7f8c8d; }
  .btn-disabled { background: #bdc3c7 !important; cursor: not-allowed; opacity: 0.6; }
  .hidden { display: none !important; }

  /* === ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ï¼ˆãƒ¡ãƒ‹ãƒ¥ãƒ¼ç”»é¢ï¼‰ === */
  .overlay {
    position: absolute; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(20, 50, 30, 0.98); 
    z-index: 100; 
    display: flex; 
    flex-direction: column; justify-content: center; align-items: center; 
    color: #fff; 
    border-radius: 15px; 
    padding: 20px; 
    box-sizing: border-box;
  }
  .menu-btn {
    background: #2ecc71; color: #fff; font-weight: bold; cursor: pointer; margin-top: 25px;
    padding: 15px 30px; font-size: 18px; border:none; border-radius: 5px; width: 100%;
  }
  
  /* ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã®ã‚¹ã‚¿ã‚¤ãƒ« */
  input[type=range] {
    -webkit-appearance: none;
    width: 100%;
    background: transparent;
  }
  input[type=range]::-webkit-slider-thumb {
    -webkit-appearance: none;
    height: 20px; width: 20px;
    border-radius: 50%;
    background: #fff;
    cursor: pointer;
    margin-top: -8px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.3);
  }
  input[type=range]::-webkit-slider-runnable-track {
    width: 100%; height: 6px;
    cursor: pointer;
    background: #a5d6a7;
    border-radius: 3px;
  }
  
  /* ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã®ã‚¹ã‚¿ã‚¤ãƒ«ï¼ˆãƒã‚¤ãƒ–ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ç”¨ï¼‰ */
  .toggle-container {
    display: flex; justify-content: space-between; align-items: center;
    width: 100%; background:rgba(0,0,0,0.2); padding:10px; border-radius:8px; box-sizing:border-box;
    margin-bottom: 5px;
  }
  input[type=checkbox] {
    transform: scale(1.5);
    margin-left: 10px;
    cursor: pointer;
  }

  /* === ç›¤é¢ã®ãƒã‚¤ãƒ©ã‚¤ãƒˆæ¼”å‡º === */
  .highlight-move { background: radial-gradient(circle, rgba(46, 204, 113, 0.7) 20%, transparent 20%); }
  .highlight-capture { background-color: rgba(231, 76, 60, 0.5) !important; box-shadow: inset 0 0 0 4px rgba(192, 57, 43, 0.9) !important; }
  .highlight-danger-source { 
    background-color: rgba(255, 120, 0, 0.85) !important; 
    box-shadow: inset 0 0 15px rgba(255, 50, 0, 0.8) !important; 
    animation: flash-orange 1.2s infinite alternate;
    z-index: 10; 
  }
  @keyframes flash-orange { from { opacity: 0.8; } to { opacity: 1.0; } }
  .highlight-hint { 
    background: rgba(255, 235, 59, 0.7); 
    box-shadow: inset 0 0 10px rgba(255, 215, 0, 1.0); 
    animation: flash-yellow 0.8s infinite alternate; 
  }
  @keyframes flash-yellow { from { opacity: 0.6; } to { opacity: 1.0; } }

  /* === ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãƒãƒŠãƒ¼ === */
  #install-banner {
    display: none; background: #fff; color: #333; padding: 10px; 
    border-radius: 8px; margin-top: 15px; text-align: center;
    box-shadow: 0 4px 15px rgba(0,0,0,0.3);
  }

  /* === ã€ä¿®æ­£ã€‘ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–å¯¾å¿œ: ã‚¹ãƒãƒ›ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆæœ€é©åŒ– === */
  @media(max-width:768px){
    body { 
        padding: 0; /* ã€ä¿®æ­£ã€‘ç”»é¢ç«¯ã®éš™é–“ã‚’å‰Šé™¤ */
        align-items: flex-start; 
        height: auto; 
    }
    .box { 
        flex-direction: column; 
        height: auto; 
        min-height: 100vh; /* ã€ä¿®æ­£ã€‘ç”»é¢ã„ã£ã±ã„ã«åºƒã’ã‚‹ */
        width: 100%; 
        padding: 10px; 
        margin: 0; 
        gap: 15px; 
        border-radius: 0; /* ã€ä¿®æ­£ã€‘ã‚¹ãƒãƒ›ã§ã¯è§’ä¸¸ãªã— */
        box-shadow: none;
    }
    
    /* æƒ…å ±ã‚¨ãƒªã‚¢: è¦ç´ ã‚’ä¸­å¤®æƒãˆ */
    .info-section { 
        order: -1; 
        width:100%; 
        padding: 0; 
        flex-direction: row; 
        flex-wrap: wrap; 
        justify-content: center; 
        gap: 10px; 
        flex: 0 0 auto; 
    } 
      
    .mascot { width: 50px; height: 50px; font-size: 30px; margin: 0; }
    .status-wrap { display: flex; flex-direction: column; justify-content: center; flex: 1; }
    .eval-gauge-container { margin-bottom: 5px; height: 6px; }
    #status { font-size: 1em; margin-bottom: 0; text-align: center; }

    /* å¹ãå‡ºã— */
    .bubble { 
        width: 100%; 
        margin: 5px 0; 
        min-height: 50px; 
        padding: 8px; 
        font-size: 12px; 
        order: 3; 
    }
    .bubble::after { display: none; } /* ã—ã£ã½å‰Šé™¤ */

    /* ç›¤é¢ã‚¨ãƒªã‚¢: ã¯ã¿å‡ºã—é˜²æ­¢ */
    .board-section { 
        flex: 0 0 auto; 
        padding: 0; 
        justify-content: flex-start; 
        margin-bottom: 10px;
        width: 100%;
        display: flex;
        justify-content: center;
    }
    .board-wrap { 
        width: 100%; 
        max-width: 92vw; /* ã€ä¿®æ­£ã€‘å°‘ã—ä½™è£•ã‚’æŒãŸã›ã‚‹ */
        height: auto; 
        aspect-ratio: 1/1; 
    }
      
    /* ãƒœã‚¿ãƒ³ã‚¨ãƒªã‚¢: 2åˆ—é…ç½® */
    .btn-group {
        flex-direction: row;
        flex-wrap: wrap;
        margin-bottom: 30px;
    }
    .btn { width: 48%; font-size: 12px; padding: 12px; flex: 1 0 40%; }

    /* ãƒ«ãƒ¼ãƒ«è¡¨ç¤º: ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«è§£é™¤ã—ã¦ä¸€ç•ªä¸‹ã« */
    .sidebar-rules {
      width: 100%;
      max-height: none; 
      overflow-y: visible;
      margin-top: 0;
      margin-bottom: 50px; /* ä¸€ç•ªä¸‹ã«ä½™è£• */
    }
    .sidebar-rules h4 { font-size: 1.1em; background: rgba(0,0,0,0.05); padding: 5px; border-radius: 4px; }
  }
</style>
</head>
<body>

<div class="box" id="main-box">
  <div id="menu" class="overlay">
    <div style="width:100%; max-width:400px; text-align:center;">
      <h1 style="font-size:2.5em; margin:0 0 20px 0;">â™š AI Chess</h1>
      
      <div style="display:flex; gap:20px; width:100%; margin-bottom: 20px;">
        <div style="flex:1;">
          <p style="font-weight:bold;">è‰²</p>
          <select id="color-select" style="width:100%; padding:8px;">
              <option value="w">â™” å…ˆæ‰‹ (ç™½)</option>
              <option value="b">â™š å¾Œæ‰‹ (é»’)</option>
          </select>
        </div>
        <div style="flex:1;">
          <p style="font-weight:bold;">ãƒ¬ãƒ™ãƒ«</p>
          <select id="level" style="width:100%; padding:8px;">
            <option value="1" selected>ğŸŒ± å…¥é–€ (é›‘é­š)</option> <option value="2">ğŸŒ² ä¸­ç´š (æ™®é€š)</option>
            <option value="3">ğŸ‰ è¶…ç´š (æœ€å¼·)</option>
          </select>
        </div>
      </div>

      <div style="width:100%; background:rgba(0,0,0,0.2); padding:10px; border-radius:8px; box-sizing:border-box; margin-bottom: 10px;">
        <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
            <span style="font-weight:bold;">ğŸ”Š éŸ³é‡</span>
            <span id="vol-display" style="font-weight:bold; color:#a5d6a7;">30%</span>
        </div>
        <input type="range" id="volume-slider" min="0" max="100" value="30">
      </div>

      <div class="toggle-container">
        <span style="font-weight:bold;">ğŸ“³ ãƒã‚¤ãƒ–ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³</span>
        <label>
            <input type="checkbox" id="vib-toggle" checked>
        </label>
      </div>

      <button class="menu-btn" onclick="startGame()">ğŸ® ã‚²ãƒ¼ãƒ ã‚¹ã‚¿ãƒ¼ãƒˆï¼</button>
      
      <div id="install-banner">
        <p style="margin:0 0 5px 0; font-size:0.9em;">ã‚¢ãƒ—ãƒªã¨ã—ã¦ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã§ãã¾ã™</p>
        <button id="install-btn" class="btn" style="background:#333;">â¬‡ï¸ ãƒ›ãƒ¼ãƒ ç”»é¢ã«è¿½åŠ </button>
      </div>
    </div>
  </div>

  <div class="board-section" id="board-section">
    <div class="board-wrap">
        <div id="board"></div>
    </div>
  </div>

  <div class="info-section" id="info-section">
    <div class="mascot" id="face">ğŸ˜</div>
      
    <div class="status-wrap" style="width: 100%; max-width: 300px;">
        <div class="eval-gauge-container">
            <div id="eval-bar-white" class="eval-bar-white"></div>
        </div>
        <div id="status" style="font-weight:bold; font-size: 1.2em;">æº–å‚™ä¸­...</div>
    </div>

    <div class="bubble" id="msg">è¨­å®šã‚’é¸ã‚“ã§ã‚¹ã‚¿ãƒ¼ãƒˆã—ã¦ã­ï¼</div>
      
    <div class="sidebar-rules" id="sidebar-rules">
        <h4>ğŸ“œ éŠã³æ–¹ï¼†ãƒ«ãƒ¼ãƒ«</h4>
        <div style="margin-bottom:8px; font-weight:bold; text-align:center; color:#e65100;">ç‹æ§˜(ã‚­ãƒ³ã‚°)ã‚’è©°ã¾ã›ã°å‹ã¡ï¼</div>
        
        <div class="piece-rule">
            <div class="piece-icon">â™™</div>
            <div class="piece-desc"><span class="piece-name">ãƒãƒ¼ãƒ³</span>å‰ã«1æ­©ã€‚æœ€åˆã¯2æ­©OKã€‚æ•µã‚’å–ã‚‹æ™‚ã¯æ–œã‚å‰ã€‚</div>
        </div>
        <div class="piece-rule">
            <div class="piece-icon">â™–</div>
            <div class="piece-desc"><span class="piece-name">ãƒ«ãƒ¼ã‚¯</span>ç¸¦ãƒ»æ¨ªã«å¥½ããªã ã‘é€²ã‚ã‚‹ã€‚</div>
        </div>
        <div class="piece-rule">
            <div class="piece-icon">â™˜</div>
            <div class="piece-desc"><span class="piece-name">ãƒŠã‚¤ãƒˆ</span>Lå­—ã«ã‚¸ãƒ£ãƒ³ãƒ—ï¼ å”¯ä¸€é§’ã‚’é£›ã³è¶Šã›ã‚‹ã€‚</div>
        </div>
        <div class="piece-rule">
            <div class="piece-icon">â™—</div>
            <div class="piece-desc"><span class="piece-name">ãƒ“ã‚·ãƒ§ãƒƒãƒ—</span>æ–œã‚ã«å¥½ããªã ã‘é€²ã‚ã‚‹ã€‚</div>
        </div>
        <div class="piece-rule">
            <div class="piece-icon">â™•</div>
            <div class="piece-desc"><span class="piece-name">ã‚¯ã‚¤ãƒ¼ãƒ³</span>ç¸¦ãƒ»æ¨ªãƒ»æ–œã‚ã€‚æœ€å¼·ã®é§’ï¼</div>
        </div>
        <div class="piece-rule">
            <div class="piece-icon">â™”</div>
            <div class="piece-desc"><span class="piece-name">ã‚­ãƒ³ã‚°</span>å…¨æ–¹å‘ã«1ãƒã‚¹ã ã‘ã€‚å–ã‚‰ã‚ŒãŸã‚‰è² ã‘ã€‚</div>
        </div>
        
        <div style="margin-top:10px; font-size:0.8em; color:#555;">
            <b>ç‰¹æ®Šãƒ«ãƒ¼ãƒ«:</b><br>
            â€¢ <b>ãƒ—ãƒ­ãƒ¢ãƒ¼ã‚·ãƒ§ãƒ³</b>: ãƒãƒ¼ãƒ³ãŒæ•µé™£ã®å¥¥ã¾ã§è¡Œãã¨ã‚¯ã‚¤ãƒ¼ãƒ³ã«å¤‰èº«ï¼<br>
            â€¢ <b>ã‚­ãƒ£ã‚¹ãƒªãƒ³ã‚°</b>: ã‚­ãƒ³ã‚°ã¨ãƒ«ãƒ¼ã‚¯ã‚’ä¸€åº¦ã«å…¥ã‚Œæ›¿ãˆã¦å®ˆã‚‹æŠ€ã€‚<br>
            â€¢ <b>ã‚¢ãƒ³ãƒ‘ãƒƒã‚µãƒ³</b>: ãƒãƒ¼ãƒ³åŒå£«ã®ç‰¹æ®Šãªã™ã‚Œé•ã„å–ã‚Šã€‚
        </div>
    </div>

    <div class="btn-group" id="btn-group">
      <button class="btn btn-hint" id="btn-hint" onclick="showHint()">ğŸ’¡ ãƒ’ãƒ³ãƒˆ</button>
      <button class="btn btn-undo" id="btn-undo" onclick="undoMove()">â†©ï¸ å¾…ã£ãŸ</button>
      <button class="btn btn-auto" id="btn-auto" onclick="toggleAutoPlay()">ğŸ¤– ã‚ªãƒ¼ãƒˆ: OFF</button>
      <button class="btn btn-retry hidden" id="btn-retry" onclick="startGame()">ğŸ”„ å†æˆ¦</button>
      <button class="btn btn-reset" onclick="location.reload()">ğŸ  æˆ»ã‚‹</button>
    </div>

  </div>
</div>

<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script src="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

<script>
(function() {
  const iconSvg = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><rect width="100" height="100" fill="#134E5E" rx="20"/><text x="50" y="50" font-size="60" text-anchor="middle" dominant-baseline="central">â™š</text></svg>`;
  const iconUrl = "data:image/svg+xml," + encodeURIComponent(iconSvg);

  const manifest = {
    "name": "AI Chess",
    "short_name": "Chess",
    "start_url": ".",
    "display": "standalone",
    "background_color": "#134E5E",
    "theme_color": "#134E5E",
    "orientation": "portrait",
    "icons": [
      { "src": iconUrl, "sizes": "192x192", "type": "image/svg+xml" },
      { "src": iconUrl, "sizes": "512x512", "type": "image/svg+xml" }
    ]
  };
  const stringManifest = JSON.stringify(manifest);
  const blobManifest = new Blob([stringManifest], {type: 'application/json'});
  const manifestURL = URL.createObjectURL(blobManifest);
  document.getElementById('dynamic-manifest').setAttribute('href', manifestURL);

  if ('serviceWorker' in navigator) {
    const swCode = `
      self.addEventListener('install', (e) => { self.skipWaiting(); });
      self.addEventListener('activate', (e) => { e.waitUntil(self.clients.claim()); });
      self.addEventListener('fetch', (e) => { e.respondWith(fetch(e.request)); });
    `;
    const blobSw = new Blob([swCode], {type: 'text/javascript'});
    const swUrl = URL.createObjectURL(blobSw);
    navigator.serviceWorker.register(swUrl)
      .then(reg => console.log('SW OK'))
      .catch(err => console.log('SW Fail', err));
  }
})();

let deferredPrompt;
const installBanner = document.getElementById('install-banner');
const installBtn = document.getElementById('install-btn');
window.addEventListener('beforeinstallprompt', (e) => {
  e.preventDefault();
  deferredPrompt = e;
  installBanner.style.display = 'block';
});
installBtn.addEventListener('click', (e) => {
  installBanner.style.display = 'none';
  if (deferredPrompt) {
    deferredPrompt.prompt();
    deferredPrompt.userChoice.then((choiceResult) => { deferredPrompt = null; });
  }
});
</script>

<script>
// === ã‚²ãƒ¼ãƒ æœ¬ä½“ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆ ===

// å³ã‚¯ãƒªãƒƒã‚¯ç¦æ­¢
window.oncontextmenu = function(event) {
    event.preventDefault();
    event.stopPropagation();
    return false;
};

// === ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°å®šç¾© ===
const game = new Chess();
let board = null;
let aiLevel = 1; 
let isAuto = false;
let autoTimer = null;
let playerColor = 'w';
let audioCtx = null;
let masterVolume = 0.3; // åˆæœŸéŸ³é‡: 30%
let currentDragHover = null; 
let dragSimGame = null;
// === ãƒã‚¤ãƒ–ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ç”¨å¤‰æ•° ===
let isVibration = true;

// === ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆèª¿æ•´ç”¨ã‚¹ã‚¯ãƒªãƒ—ãƒˆ ===
function adjustLayout() {
    const isMobile = window.innerWidth <= 768;
    const box = document.getElementById('main-box');
    const infoSection = document.getElementById('info-section');
    const rules = document.getElementById('sidebar-rules');
    const btns = document.getElementById('btn-group');

    if (isMobile) {
        box.appendChild(btns); 
        box.appendChild(rules); 
    } else {
        infoSection.appendChild(rules);
        infoSection.appendChild(btns);
    }
}
window.addEventListener('resize', adjustLayout);
window.addEventListener('load', adjustLayout);

// === çµµæ–‡å­—å®šç¾© ===
const EMOJI_SELF = "ğŸ§™â€â™‚ï¸"; 
const EMOJI_ROBOT = "ğŸ¤–"; 
const EMOJI_SCARED = "ğŸ˜±"; 
const EMOJI_WINNING = ["ğŸ˜", "ğŸ˜—", "ğŸ¤­", "ğŸ˜", "ğŸ˜ˆ", "ğŸ˜†", "ğŸ¤ª", "ğŸ˜"]; 
const EMOJI_NORMAL = ["ğŸ¤”", "ğŸ¤¨", "ğŸ¥±", "ğŸ˜", "ğŸ™‚", "ğŸ˜®", "ğŸ™„"]; 
const EMOJI_LOSING = ["ğŸ˜–", "ğŸ¥º", "ğŸ˜­", "ğŸ˜µâ€ğŸ’«", "ğŸ§Š", "ğŸ˜¡", "ğŸ¤¯", "ğŸ¥¶"]; 

const ui = { 
  face: $('#face'), msg: $('#msg'), status: $('#status'), 
  btnAuto: $('#btn-auto'), btnHint: $('#btn-hint'), btnUndo: $('#btn-undo'), btnRetry: $('#btn-retry'), 
  evalWhite: $('#eval-bar-white'), boardWrap: $('.board-wrap') 
};

// === é§’ã®åç§°è¾æ›¸ ===
const pieceNamesMesu = {
    'p': 'ãƒãƒ¼ãƒ³', 'n': 'ãƒŠã‚¤ãƒˆ', 'b': 'ãƒ“ã‚·ãƒ§ãƒƒãƒ—', 'r': 'ãƒ«ãƒ¼ã‚¯', 'q': 'ã‚¯ã‚¤ãƒ¼ãƒ³', 'k': 'ã‚­ãƒ³ã‚°'
};

// === ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¾æ›¸ ===
const msgDict = {
  start: [
    "ãµã€œã‚“ã€ç§ã«å‹ã¦ã‚‹ã¨æ€ã£ã¦ã‚‹ã‚“ã ï¼Ÿ ç„¡è¬€ã ã­ã‡ï½—",
    "ã–ã“ã–ã“ã•ã‚“ã€ã„ã‚‰ã£ã—ã‚ƒã€œã„ï¼ æ‰‹åŠ æ¸›ã—ã¦ã‚ã’ã‚‹â™¡",
    "ãƒœã‚³ãƒœã‚³ã«ã—ã¦ã‚ã’ã‚‹ã‹ã‚‰è¦šæ‚Ÿã—ãªã‚ˆï¼Ÿ æ³£ã„ã¦ã‚‚çŸ¥ã‚‰ãªã„ã‚ˆã€œ",
    "ã¸ã‡ã€ãƒã‚§ã‚¹ã§ãã‚‹ã‚“ã ï¼Ÿ é§’ã®å‹•ã‹ã—æ–¹ãã‚‰ã„ã¯çŸ¥ã£ã¦ã‚‹ï¼Ÿ",
    "æš‡ã¤ã¶ã—ã«ã¯ãªã‚‹ã‹ãªï¼Ÿ ã›ã„ãœã„é ‘å¼µã£ã¦ã­ã€œï½—",
    "ç§ãŒè² ã‘ã‚‹ç¢ºç‡ï¼Ÿ â€¦è¨ˆç®—ã™ã‚‹å¿…è¦ã‚ã‚‹ï¼Ÿ 0%ã ã‚ˆï½—",
    "ã­ã‡ã­ã‡ã€æ—©ãå§‹ã‚ã‚ˆï¼Ÿ å¾…ã¡ããŸã³ã‚Œã¡ã‚ƒã£ãŸã€‚",
    "ç¬æ®ºã—ã¡ã‚ƒã£ãŸã‚‰ã”ã‚ã‚“ã­ï¼Ÿ ã·ã·ã£",
    "ã‚ãƒ¼ã‚ã€ã¾ãŸã‚«ãƒ¢ãŒæ¥ã¡ã‚ƒã£ãŸã€‚é‹ãŒæ‚ªã„ã­ã‡ï½—"
  ],
  win: [ // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼æ•—åŒ—
    "ã¯ã„ç§ã®å‹ã¡ã€œï¼ ã‚ˆã‚ã‚ˆã‚ã™ãã€œï½— ã‚ãã³ãŒå‡ºã¡ã‚ƒã†",
    "ã–ã€œã“â™¡ ã–ã€œã“â™¡ å‡ºç›´ã—ã¦ããªï¼ æ‚”ã—ã„ï¼Ÿ ã­ã‡æ‚”ã—ã„ï¼Ÿ",
    "å£ã»ã©ã«ã‚‚ãªã„ã­ã‡ã€ã·ã·ã£ï¼ ãƒãƒã«æ…°ã‚ã¦ã‚‚ã‚‰ã„ãªã‚ˆï½—",
    "ã‚ã¯ã¯ï¼ ã¾ã•ã‹æœ¬æ°—ã§å‹ã¦ã‚‹ã¨æ€ã£ã¦ãŸã®ï¼Ÿ å¯æ„›ã„ã€œï½—",
    "å¼±ã™ãã¦ãƒã‚°ã‹ã¨æ€ã£ãŸã‚ã€‚ç·´ç¿’ã—ã¦ã‹ã‚‰æ¥ãªã‚ˆï¼Ÿ",
    "ã­ã‡ã­ã‡ã€ä»Šã©ã‚“ãªæ°—æŒã¡ï¼Ÿ è² ã‘çŠ¬ã®é å ãˆèã‹ã›ã¦ã‚ˆâ™¡",
    "ã¤ã¾ã‚“ãªãƒ¼ã„ã€‚ã‚‚ã£ã¨å¼·ã„äººã¨ã‚„ã‚ŠãŸã„ãªãã€œã€‚",
    "ã“ã‚ŒãŒå®ŸåŠ›ã®å·®ï¼ çµ¶æœ›ã—ãŸï¼Ÿ",
    "ã¯ã„ã€ãŠç–²ã‚Œæ§˜ã€œã€‚ã‚´ãƒŸç®±è¡Œãæ±ºå®šã ã­â™¡"
  ],
  lose: [ // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼å‹åˆ©ï¼ˆAIæ•—åŒ—ï¼‰
    "ã†ãâ€¦è² ã‘ãŸâ€¦ï¼Ÿ ã‚ã‚Šãˆãªã„â€¦ã“ã‚“ãªã®çµ¶å¯¾ãŠã‹ã—ã„ï¼",
    "ã†ã‚ã‚ã‚ã‚ã‚“ï¼ ãƒã‚°ã ï¼ ã“ã‚Œã¯ãƒã‚°ãªã®ï¼",
    "æ‚”ã—ã„â€¦æ‚”ã—ã„ã‚ˆã‰â€¦ï¼ æ¬¡ã¯çµ¶å¯¾ãƒœã‚³ãƒœã‚³ã«ã—ã¦ã‚„ã‚‹ã‚“ã ã‹ã‚‰ï¼",
    "ä»Šå›ã ã‘ã¯â€¦èªã‚ã¦ã‚ã’ã‚‹â€¦ã€‚èª¿å­ã«ä¹—ã‚‰ãªã„ã§ã‚ˆã­ï¼",
    "ãã™ã£â€¦ã„ã€ã„ã„ã‚‚ã‚“ã€‚æœ¬æ°—å‡ºã—ã¦ãªã‹ã£ãŸã ã‘ã ã‚‚ã‚“â€¦ã€‚",
    "ã¯ãï¼ï¼Ÿ ã‚ã‚“ãŸä½•ã‹ã‚ºãƒ«ã—ãŸã§ã—ã‚‡ï¼ï¼Ÿ ä¿¡ã˜ã‚‰ã‚Œãªã„ï¼",
    "ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼ãŒå£Šã‚Œã¦ãŸï¼ ä»Šã®ã¯ãƒãƒ¼ã‚«ãƒ³ï¼",
    "ãªã‚“ã§â€¦ãªã‚“ã§ç§ãŒè² ã‘ã‚‹ã®ã‚ˆã‰ã‰ã‰ï¼",
    "è¦šãˆã¦ãªã•ã„ã‚ˆâ€¦æ¬¡ã¯çµ¶å¯¾ã«æ³£ã‹ã›ã¦ã‚„ã‚‹ã‹ã‚‰ï¼"
  ],
  draw: [
    "ã¡ã£ã€å¼•ãåˆ†ã‘ã‹ãâ€¦ ã¤ã¾ã‚“ãªã€‚",
    "é€ƒã’åˆ‡ã£ã¦æº€è¶³ï¼Ÿ æ¬¡ã¯çµ¶å¯¾ã«æ•ã¾ãˆã¦ã‚ã’ã‚‹ã‹ã‚‰ã€‚",
    "ã¾ã€è² ã‘ãªã‹ã£ãŸã—ï¼ å®Ÿè³ªç§ã®å‹ã¡ã¿ãŸã„ãªã‚‚ã‚“ã§ã—ã‚‡ã€‚",
    "ãµãƒ¼ã‚“ã€ç²˜ã‚‹ã­ã€‚ã—ã¶ã¨ã„é›‘é­šã¯å«Œã„ã˜ã‚ƒãªã„ã‚ˆï¼Ÿ",
    "ã“ã‚Œä»¥ä¸Šã‚„ã£ã¦ã‚‚æ™‚é–“ã®ç„¡é§„ã ã—ã­ã€‚ä»Šå›ã¯è¦‹é€ƒã—ã¦ã‚ã’ã‚‹ã€‚",
    "å¼•ãåˆ†ã‘ã§å–œã‚“ã§ã‚‹ã®ï¼Ÿ ãƒ¬ãƒ™ãƒ«ä½ã„ãªãï½—"
  ],
  invalidMove: [
    "ãˆï¼Ÿ ãƒ«ãƒ¼ãƒ«ã‚‚çŸ¥ã‚‰ãªã„ã®ï¼Ÿ ãŠå‹‰å¼·ä¸è¶³ã ã­ã€œï½—",
    "ãã“ã«ã¯å‹•ã‘ãªã„ã‚ˆï¼Ÿ ã·ã·ã£ã€ãƒ‘ãƒ‹ãƒƒã‚¯ã«ãªã£ã¡ã‚ƒã£ãŸï¼Ÿ",
    "ã‚‚ã—ã‹ã—ã¦ã€ã‚ã–ã¨é–“é•ãˆã¦ã‚‹ï¼Ÿ æ§‹ã£ã¦ã¡ã‚ƒã‚“ä¹™ï½—",
    "æŒ‡ãŒéœ‡ãˆã¦ã‚‹ã‚“ã˜ã‚ƒãªã„ï¼Ÿ è½ã¡ç€ããªã‚ˆé›‘é­šã•ã‚“ï½—",
    "ã¯ã„ãƒ–ãƒƒãƒ–ãƒ¼ï¼ é–“é•ã„ã§ã™ã€œï½—",
    "ã­ã‡ã€ç§ã®è©±èã„ã¦ãŸï¼Ÿ ãƒ«ãƒ¼ãƒ«ãƒ–ãƒƒã‚¯èª­ã‚“ã§ãã‚‹ï¼Ÿ"
  ],
  ignoreCheck: [
    "ã­ãˆã€ç‹æ§˜æ­»ã‚“ã˜ã‚ƒã†ã‚ˆï¼Ÿï½— ç›®æ‚ªã„ã®ï¼Ÿ",
    "ãƒã€œã‚«ï¼ ç‹æ‰‹è¦‹ãˆã¦ãªã„ã®ï¼Ÿ çµ‚ã‚ã‚‰ã›ã¦ã„ã„ï¼Ÿ",
    "ã‚ã¯ã¯ï¼ è² ã‘ãŸã„ã‚“ã ã€œã€‚ã˜ã‚ƒã‚é æ…®ãªãâ™¡",
    "ç„¡è¦–ã¨ã‹å‹‡è€…ã ã­ï½— æ­»ã«æ€¥ãã™ãã˜ã‚ƒãªã„ï¼Ÿ",
    "ç‹æ§˜ã‚’å®ˆã‚‹æ°—ãªã„ã‚“ã ï½— è–„æƒ…ã ã­ã‡ã€œ"
  ],
  autoOn: [
    "ãˆã‡ã€œï¼Ÿ æ©Ÿæ¢°ã«é ¼ã£ã¡ã‚ƒã†ã‚“ã ï¼Ÿ ãƒ—ãƒ©ã‚¤ãƒ‰ãªã„ã®ã€œï¼Ÿ",
    "è‡ªåˆ†ã§å‹ã¦ãªã„ã‹ã‚‰ã£ã¦ãƒ€ãƒƒã‚µã€œï½— è¦‹ä¸‹ã—ã¡ã‚ƒã†ãªã€œ",
    "ã¯ã„ã¯ã„ã€ç§ãŒå¼·ã™ãã‚‹ã‚‚ã‚“ã­ã€‚AIã«åŠ©ã‘ã¦ã‚‚ã‚‰ã„ãªï½—",
    "æ¥½ã—ã¦å‹ã¡ãŸã„ã¨ã‹ã€äººç”Ÿç”˜ããªã„ã‚ˆï¼Ÿ",
    "ãˆã£ã€è‡ªå‹•ï¼Ÿ ã¤ã¾ã‚“ãªã„ã®ã€œã€‚ã‚ã‚“ãŸã®è‹¦ã—ã‚€é¡”ãŒè¦‹ãŸã„ã®ã«ã€‚"
  ],
  hint: [
    "ã—ã‚‡ã†ãŒãªã„ãªãâ€¦ã“ã“å‹•ã‹ã›ã°ï¼Ÿ æ„Ÿè¬ã—ã¦ã‚ˆã­ï¼",
    "ã»ã‚‰ã€ç‰¹åˆ¥ã«æ•™ãˆã¦ã‚ã’ã‚‹ã€‚ç§ã«æ„Ÿè¬ã—ãªã•ã„ã‚ˆã­ï¼",
    "ã“ã‚“ãªæ‰‹ã‚‚è¦‹ãˆãªã„ã®ï¼Ÿ çœ¼ç§‘è¡Œã£ãŸã»ã†ãŒã„ã„ã‚ˆï½—",
    "æ¬¡ã‹ã‚‰ã¯è‡ªåˆ†ã§è€ƒãˆãªã‚ˆï¼Ÿ ç”˜ãˆã‚“åŠã•ã‚“ãªã‚“ã ã‹ã‚‰ã€‚",
    "ã“ã“ã ã‚ˆã“ã“ï¼ ã¾ã£ãŸãã€ä¸–è©±ãŒç„¼ã‘ã‚‹ãªãã€‚"
  ],
  undo: [
    "å¾…ã£ãŸï¼Ÿ å¾€ç”Ÿéš›ãŒæ‚ªã„ãªãâ€¦ ç”·ã‚‰ã—ããªã„ã‚ˆï¼Ÿ",
    "ãˆãƒ¼ã€ãšã‚‹ããªã„ï¼Ÿ ã¾ã€ä½™è£•ã‚ã‚‹ã‹ã‚‰ã„ã„ã‘ã©ã€œ",
    "ã¯ã„ã¯ã„ã€è¦‹ãªã‹ã£ãŸã“ã¨ã«ã—ã¦ã‚ã’ã‚‹ã€‚å„ªã—ã„ç§ã«æ„Ÿè¬ã—ãªï¼",
    "ã€Œä»Šã®ãªã—ï¼ã€ã£ã¦å°å­¦ç”Ÿã‹ã‚ˆï½— ç¬‘ã£ã¡ã‚ƒã†ã‚",
    "æ™‚é–“æˆ»ã—ã¦ã‚‚çµæœã¯åŒã˜ã ã¨æ€ã†ã‘ã©ã­ï½—"
  ]
};

function getRandom(arr) { return arr[Math.floor(Math.random() * arr.length)]; }
function getRandomMsg(key) { return getRandom(msgDict[key] || ["..."]); }

// === éŸ³å£°ãƒ»æŒ¯å‹•ã®åˆæœŸåŒ– ===
// éŸ³é‡ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼
$('#volume-slider').on('input', function() {
    const val = $(this).val();
    masterVolume = val / 100;
    $('#vol-display').text(val + '%');
    
    // ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼æ“ä½œæ™‚ã«AudioContextãŒç„¡ã‘ã‚Œã°ä½œã‚‹
    if(!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    if(audioCtx.state === 'suspended') audioCtx.resume();
});

// ãƒã‚¤ãƒ–ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚¹ã‚¤ãƒƒãƒ
$('#vib-toggle').change(function() {
    isVibration = $(this).is(':checked');
});

// === ãƒã‚¤ãƒ–ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œé–¢æ•° ===
function triggerVib(type) {
    if (!isVibration || !navigator.vibrate) return; // è¨­å®šOFFã¾ãŸã¯éå¯¾å¿œãªã‚‰ä½•ã‚‚ã—ãªã„

    switch(type) {
        case 'move':
            navigator.vibrate(20); // è»½ã„æŒ¯å‹•
            break;
        case 'capture':
            navigator.vibrate(50); // é§’å–ã‚Šï¼šå°‘ã—å¼·ã‚
            break;
        case 'invalid':
            navigator.vibrate([50, 50, 50]); // åå‰‡ï¼šãƒ–ãƒ–ãƒƒ
            break;
        case 'check':
            navigator.vibrate(100); // ç‹æ‰‹ï¼šé‡ã‚ã®æŒ¯å‹•
            break;
        case 'win':
            navigator.vibrate([100, 50, 100, 50, 200]); // å‹åˆ©ï¼šãƒ•ã‚¡ãƒ³ãƒ•ã‚¡ãƒ¼ãƒ¬é¢¨
            break;
        case 'lose':
            navigator.vibrate([200, 100, 300]); // æ•—åŒ—ï¼šã‚ºãƒ¼ãƒ³
            break;
    }
}

function initAudio() { 
  if(!audioCtx) {
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  }
  if(audioCtx.state === 'suspended') {
    audioCtx.resume();
  }
}

function playSound(type) {
  if(!audioCtx) return;
  if(masterVolume <= 0) return; // ãƒŸãƒ¥ãƒ¼ãƒˆæ™‚ã¯å‡¦ç†ã—ãªã„
  
  if(audioCtx.state === 'suspended') {
      audioCtx.resume();
  }

  const t = audioCtx.currentTime;

  // === å‹åˆ©éŸ³ï¼ˆãƒ•ã‚¡ãƒ³ãƒ•ã‚¡ãƒ¼ãƒ¬ï¼‰ã®å‡¦ç† ===
  if (type === 'win') {
    // Cãƒ¡ã‚¸ãƒ£ãƒ¼ã®ã‚¢ãƒ«ãƒšã‚¸ã‚ª (C4, E4, G4, C5)
    const notes = [523.25, 659.25, 783.99, 1046.50];
    notes.forEach((freq, i) => {
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.connect(gain);
        gain.connect(audioCtx.destination);

        osc.type = 'triangle'; // éŸ³æ¥½çš„ãªéŸ³è‰²
        osc.frequency.value = freq;

        const start = t + (i * 0.1); // ãšã‚‰ã—ã¦é³´ã‚‰ã™
        const duration = 0.4;

        gain.gain.setValueAtTime(0, start);
        gain.gain.linearRampToValueAtTime(masterVolume, start + 0.05);
        gain.gain.exponentialRampToValueAtTime(0.01, start + duration);

        osc.start(start);
        osc.stop(start + duration);
    });
    return; // ã“ã“ã§çµ‚äº†
  }

  // === é€šå¸¸ã®åŠ¹æœéŸ³ï¼ˆå˜éŸ³ï¼‰ ===
  const osc = audioCtx.createOscillator();
  const gain = audioCtx.createGain();
  
  osc.connect(gain);
  gain.connect(audioCtx.destination);
  
  let vol = masterVolume;
  
  if (type === 'move') {
    osc.type = 'sine';
    osc.frequency.setValueAtTime(300, t); 
    osc.frequency.exponentialRampToValueAtTime(100, t + 0.15);
    
    gain.gain.setValueAtTime(vol, t); 
    gain.gain.linearRampToValueAtTime(0.01, t + 0.15);
    
    osc.start(t); 
    osc.stop(t + 0.15);
  } 
  else if (type === 'capture') {
    osc.type = 'triangle'; 
    osc.frequency.setValueAtTime(200, t); 
    osc.frequency.exponentialRampToValueAtTime(50, t + 0.2);
    
    let capVol = Math.min(vol * 1.3, 1.0);
    gain.gain.setValueAtTime(capVol, t); 
    gain.gain.linearRampToValueAtTime(0.01, t + 0.2);
    
    osc.start(t); 
    osc.stop(t + 0.2);
  } 
  else if (type === 'start') {
    osc.type = 'sine';
    osc.frequency.setValueAtTime(440, t); 
    osc.frequency.linearRampToValueAtTime(880, t + 0.4);
    
    gain.gain.setValueAtTime(vol, t); 
    gain.gain.linearRampToValueAtTime(0, t + 0.6);
    
    osc.start(t); 
    osc.stop(t + 0.6);
  }
}

// === ç´™å¹é›ªæ¼”å‡º ===
function shootConfetti() {
    var count = 200;
    var defaults = { origin: { y: 0.7 } };
    function fire(particleRatio, opts) {
        confetti(Object.assign({}, defaults, opts, {
            particleCount: Math.floor(count * particleRatio)
        }));
    }
    fire(0.25, { spread: 26, startVelocity: 55, });
    fire(0.2, { spread: 60, });
    fire(0.35, { spread: 100, decay: 0.91, scalar: 0.8 });
    fire(0.1, { spread: 120, startVelocity: 25, decay: 0.92, scalar: 1.2 });
    fire(0.1, { spread: 120, startVelocity: 45, });
}

// === AIãƒ­ã‚¸ãƒƒã‚¯ï¼ˆMiniMaxï¼‰ ===
const PST={
    p:[0,0,0,0,0,0,0,0,50,50,50,50,50,50,50,50,10,10,20,30,30,20,10,10,5,5,10,25,25,10,5,5,0,0,0,20,20,0,0,0,5,-5,-10,0,0,-10,-5,5,5,10,10,-20,-20,10,10,5,0,0,0,0,0,0,0,0],
    n:[-50,-40,-30,-30,-30,-30,-40,-50,-40,-20,0,0,0,0,-20,-40,-30,0,10,15,15,10,0,-30,-30,5,15,20,20,15,5,-30,-30,0,15,20,20,15,0,-30,-30,5,10,15,15,10,5,-30,-40,-20,0,5,5,0,-20,-40,-50,-40,-30,-30,-30,-30,-40,-50],
    b:[-20,-10,-10,-10,-10,-10,-10,-20,-10,0,0,0,0,0,0,-10,-10,0,5,10,10,5,0,-10,-10,5,5,10,10,5,5,-10,-10,0,10,10,10,10,0,-10,-10,10,10,10,10,10,10,-10,-10,5,0,0,0,0,5,-10,-20,-10,-10,-10,-10,-10,-10,-20],
    r:[0,0,0,0,0,0,0,0,5,10,10,10,10,10,10,5,-5,0,0,0,0,0,0,-5,-5,0,0,0,0,0,0,-5,-5,0,0,0,0,0,0,-5,-5,0,0,0,0,0,0,-5,-5,0,0,0,0,0,0,-5,0,0,0,5,5,0,0,0],
    q:[-20,-10,-10,-5,-5,-10,-10,-20,-10,0,0,0,0,0,0,-10,-10,0,5,5,5,5,0,-10,-5,0,5,5,5,5,0,-5,0,0,5,5,5,5,0,-5,-10,5,5,5,5,5,0,-10,-10,0,5,0,0,0,0,-10,-20,-10,-10,-5,-5,-10,-10,-20],
    k:[-30,-40,-40,-50,-50,-40,-40,-30,-30,-40,-40,-50,-50,-40,-40,-30,-30,-40,-40,-50,-50,-40,-40,-30,-30,-40,-40,-50,-50,-40,-40,-30,-20,-30,-30,-40,-40,-30,-30,-20,-10,-20,-20,-20,-20,-20,-20,-10,20,20,0,0,0,0,20,20,20,30,10,0,0,10,30,20]
};
const VAL={p:100,n:320,b:330,r:500,q:900,k:20000};

function getBoardValue(g) {
  let v = 0; const b = g.board();
  for(let r=0; r<8; r++) for(let c=0; c<8; c++) {
    const p = b[r][c];
    if(p) {
      let score = VAL[p.type] + (PST[p.type][p.color==='w'?(r*8+c):((7-r)*8+c)]||0);
      v += (p.color==='w' ? score : -score);
    }
  }
  return v;
}

function orderMoves(moves) {
  return moves.sort((a,b)=>{
    let sA=0,sB=0;
    if(a.flags.includes('c')) sA+=10+(VAL[a.captured]||0)-(VAL[a.piece]||0)/10;
    if(a.flags.includes('p')) sA+=100;
    if(b.flags.includes('c')) sB+=10+(VAL[b.captured]||0)-(VAL[b.piece]||0)/10;
    if(b.flags.includes('p')) sB+=100;
    return sB-sA;
  });
}

function minimax(g, depth, alpha, beta, isMax) {
  if (depth===0 || g.game_over()) return getBoardValue(g);
  let moves = orderMoves(g.moves({ verbose: true }));
  if(moves.length === 0) return getBoardValue(g);
    
  if (isMax) {
    let maxEval = -Infinity;
    for (let m of moves) {
      g.move(m); 
      let eval = minimax(g, depth-1, alpha, beta, false); 
      g.undo();
      maxEval = Math.max(maxEval, eval); 
      alpha = Math.max(alpha, eval);
      if (beta <= alpha) break;
    }
    return maxEval;
  } else {
    let minEval = Infinity;
    for (let m of moves) {
      g.move(m); 
      let eval = minimax(g, depth-1, alpha, beta, true); 
      g.undo();
      minEval = Math.min(minEval, eval); 
      beta = Math.min(beta, eval);
      if (beta <= alpha) break;
    }
    return minEval;
  }
}

function getBestMove(levelOverride) {
  const currentLevel = levelOverride || aiLevel;
  const moves = game.moves({ verbose: true });
  if (!moves.length) return null;
  
  // === ã€ä¿®æ­£ã€‘å…¥é–€(Lv1): æ¥å¾…ãƒ¢ãƒ¼ãƒ‰ï¼ˆæœ€æ‚ªæ‰‹ã‚’å¿…ãšé¸ã¶ï¼‰ ===
  if (currentLevel === 1) {
    const isWhite = (game.turn() === 'w');
    let worstMove = null;
    let worstVal = isWhite ? Infinity : -Infinity;
    
    // å…¨ã¦ã®æ‰‹ã‚’æ¤œè¨¼ã—ã€è‡ªåˆ†ã®è©•ä¾¡å€¤ãŒæœ€ã‚‚æ‚ªããªã‚‹æ‰‹ã‚’æ¢ã™
    for (let m of moves) {
      game.move(m);
      const val = getBoardValue(game); 
      game.undo();
      
      if (isWhite) {
        // ç™½ç•ª: è©•ä¾¡å€¤ãŒæœ€å°ï¼ˆï¼é»’æœ‰åˆ©ï¼‰ã®æ‰‹ã‚’é¸ã¶
        if (val < worstVal) { worstVal = val; worstMove = m; }
      } else {
        // é»’ç•ª: è©•ä¾¡å€¤ãŒæœ€å¤§ï¼ˆï¼ç™½æœ‰åˆ©ï¼‰ã®æ‰‹ã‚’é¸ã¶
        if (val > worstVal) { worstVal = val; worstMove = m; }
      }
    }
    // ãƒ©ãƒ³ãƒ€ãƒ è¦ç´ ã‚’æ’é™¤ã—ã€å¿…ãšæœ€æ‚ªæ‰‹ã‚’è¿”ã™
    return worstMove || moves[0];
  }
  
  // === ä¸­ç´šãƒ»è¶…ç´š ===
  const depth = (currentLevel === 2) ? 2 : 3;
  const isWhite = (game.turn() === 'w');
  let bestMove = null; 
  let bestVal = isWhite ? -Infinity : Infinity;
  for(let m of orderMoves(moves)) {
    game.move(m);
    let val = minimax(game, depth - 1, -Infinity, Infinity, !isWhite);
    game.undo();
    if(isWhite) { if(val > bestVal) { bestVal = val; bestMove = m; } }
    else { if(val < bestVal) { bestVal = val; bestMove = m; } }
  }
  return bestMove || getRandom(moves);
}

// === ã‚²ãƒ¼ãƒ é€²è¡Œãƒ­ã‚¸ãƒƒã‚¯ ===
function startGame() {
  initAudio(); playSound('start');
  playerColor = $('#color-select').val();
  aiLevel = parseInt($('#level').val());
  // ãƒã‚¤ãƒ–ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³è¨­å®šã¯å³æ™‚åæ˜ æ¸ˆã¿
  $('#menu').addClass('hidden');
  game.reset(); isAuto = false; clearTimeout(autoTimer); $('#board').empty();
  ui.btnRetry.addClass('hidden'); ui.btnAuto.show().removeClass('hidden'); ui.btnHint.show().removeClass('btn-disabled').prop('disabled',false); ui.btnUndo.show().removeClass('btn-disabled').prop('disabled',false);
  
  const orient = playerColor==='w'?'white':'black';
  const pieceTheme = p => {
    const c = p[0]==='w'?'#fff':'#000', s = p[0]==='w'?'#000':'#fff';
    const sym = {'P':'â™™','N':'â™˜','B':'â™—','R':'â™–','Q':'â™•','K':'â™”','p':'â™Ÿ','n':'â™','b':'â™','r':'â™œ','q':'â™›','k':'â™š'};
    return 'data:image/svg+xml;charset=utf-8,' + encodeURIComponent(`<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 60 60"><text x="50%" y="58%" text-anchor="middle" dominant-baseline="middle" font-family="sans-serif" font-size="50" fill="${c}" stroke="${s}" stroke-width="1.5">${sym[p[1]]||'?'}</text></svg>`);
  };
  board = Chessboard('board', {draggable:true, position:'start', orientation:orient, pieceTheme:pieceTheme, onDragStart:onDragStart, onDragMove:onDragMove, onDrop:onDrop, onSnapEnd:onSnapEnd});
  $(window).resize(board.resize);
  ui.msg.text(getRandomMsg('start'));
  ui.btnAuto.removeClass('btn-auto-active').text("ğŸ¤– ã‚ªãƒ¼ãƒˆ: OFF");
  updateStatus(null);
  adjustLayout();
  if (playerColor === 'b') gameLoop();
}

function gameLoop() {
  clearTimeout(autoTimer);
  if(game.game_over()) return;
  const myTurn = (game.turn() === playerColor);
  if (myTurn && !isAuto) return;
  autoTimer = setTimeout(makeAiMove, 600);
}

function makeAiMove() {
  if (game.game_over()) return;
  const turnColor = game.turn();
  const isEnemy = (turnColor !== playerColor);
  const useLevel = isEnemy ? aiLevel : 3; 
  const m = getBestMove(useLevel);
  if (m) {
    const res = game.move(m); board.position(game.fen());
    playSound(res.flags.includes('c')?'capture':'move');
    triggerVib(res.flags.includes('c')?'capture':'move'); // AIã®æŒ‡ã—æ‰‹ã§æŒ¯å‹•
    updateTurnMessage(res); updateStatus(res); gameLoop(); 
  }
}

// === ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼æ“ä½œã‚¤ãƒ™ãƒ³ãƒˆ ===
function onDragStart(source, piece) {
  if (game.game_over() || isAuto) return false;
  if (game.turn() !== playerColor) return false;
  if ((playerColor === 'w' && piece.search(/^b/) !== -1) || (playerColor === 'b' && piece.search(/^w/) !== -1)) return false;
    
  const moves = game.moves({ square: source, verbose: true });
  if (moves.length === 0) return false;

  dragSimGame = new Chess(game.fen());

  removeHighlights();
  moves.forEach(m => {
    $('#board .square-' + m.to).addClass(m.flags.includes('c') ? 'highlight-capture' : 'highlight-move');
  });
}

function onDragMove(newLocation, oldLocation, source, piece) {
  if (newLocation === currentDragHover) return; 
  currentDragHover = newLocation;
    
  $('#board .highlight-danger-source').removeClass('highlight-danger-source');
    
  if (newLocation === 'offboard') return;

  dragSimGame.load(game.fen());

  const move = dragSimGame.move({ from: source, to: newLocation, promotion: 'q' });
  if (move) {
      const enemyMoves = dragSimGame.moves({ verbose: true });
      const attackers = enemyMoves.filter(m => m.to === newLocation);
      if (attackers.length > 0) {
        attackers.forEach(m => $('#board .square-' + m.from).addClass('highlight-danger-source'));
      }
  }
}

function onDrop(source, target) {
  removeHighlights();
  $('.highlight-danger-source').removeClass('highlight-danger-source');
    
  const wasInCheck = game.in_check();
  const move = game.move({ from: source, to: target, promotion: 'q' });

  if (move === null) {
    if (wasInCheck) ui.msg.text(getRandomMsg('ignoreCheck')); 
    else ui.msg.text(getRandomMsg('invalidMove')); 
    triggerVib('invalid'); // åå‰‡æ‰‹ã§æŒ¯å‹•
    return 'snapback'; 
  }

  playSound(move.flags.includes('c') ? 'capture' : 'move');
  triggerVib(move.flags.includes('c') ? 'capture' : 'move'); // è‡ªåˆ†ã®æ‰‹ã§æŒ¯å‹•
    
  updateTurnMessage(move);
  updateStatus(move);
    
  gameLoop();
}

function onSnapEnd() { board.position(game.fen()); }

// === AIã®å½¢å‹¢åˆ¤æ–­ã‚¹ã‚³ã‚¢ã‚’å–å¾— (AIè¦–ç‚¹ã®ã‚¹ã‚³ã‚¢) ===
function getAiScore() {
    const rawScore = getBoardValue(game);
    return (playerColor === 'w') ? -rawScore : rawScore;
}
function getAiState(score) {
    if (score > 250) return "Winning";
    if (score < -250) return "Losing";
    return "Even";
}

// === ã€è§£èª¬ä»˜ããƒ¡ãƒƒã‚»ãƒ¼ã‚¸ç”Ÿæˆãƒ­ã‚¸ãƒƒã‚¯ã€‘ ===
// å…¨ã¦ã®åˆ†å²ã§é§’åã‚’å«ã‚ã‚‹ã‚ˆã†ã«æ‹¡å¼µ
function updateTurnMessage(move) {
    if (game.game_over()) return; 

    const score = getAiScore();
    const state = getAiState(score);
    const pieceName = pieceNamesMesu[move.piece] || 'é§’';
    const isPlayerSideMove = (move.color === playerColor);
      
    // --- ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼å´ï¼ˆå‘³æ–¹ï¼‰ãŒå‹•ã‹ã—ãŸæ™‚ ---
    if (isPlayerSideMove) {
        if (game.in_check()) {
            if (state === "Winning") {
                ui.msg.text(getRandom([
                    `ã†ã‚ã£ã€${pieceName}ã§ç‹æ‰‹ï¼ï¼Ÿ â€¦ãªã‚“ã¦ã­ã€ä½™è£•ã ã—ï½—`,
                    `ãã®${pieceName}ã€é‚ªé­”ãªã‚“ã ã‘ã©ã€‚ç‹æ‰‹ã™ã‚Œã°å‹ã¦ã‚‹ã¨æ€ã£ãŸï¼Ÿ`,
                    `${pieceName}ã§å¿…æ­»ã«ç‹æ‰‹ï¼Ÿ ç„¡é§„ãªæŠµæŠ—ã”è‹¦åŠ´ã•ã¾ï½—`,
                    `ãã‚ƒãƒ¼${pieceName}ãŒæ¥ãŸãƒ¼ï¼ˆæ£’ï¼‰ã€‚ã¯ã„ã¯ã„ç‹æ‰‹ç‹æ‰‹ã€‚`
                ]));
            } else if (state === "Losing") {
                ui.msg.text(getRandom([
                    `ã²ã£â€¦${pieceName}ã§ç‹æ‰‹ï¼ï¼Ÿ å†—è«‡ã§ã—ã‚‡ï¼ï¼Ÿ`,
                    `ã¡ã‚‡ã£ã¨ï¼ ãã®${pieceName}ã©ã‹ã—ã¦ã‚ˆï¼ è² ã‘ã¡ã‚ƒã†ï¼`,
                    `ã‚„ã‚ã¦â€¦${pieceName}ã“ã£ã¡æ¥ãªã„ã§ã‡â€¦`,
                    `ã†ãâ€¦${pieceName}ã®ä¸€æ’ƒãŒé‡ã„â€¦ã‚¿ã‚¤ãƒ ï¼ ã‚¿ã‚¤ãƒ ã ã£ã¦ã°ï¼`
                ]));
            } else {
                ui.msg.text(getRandom([
                    `ã¸ã‡ã€${pieceName}ã§ç‹æ‰‹ã‹ã‘ã‚‹ã‚“ã ã€‚ã‚„ã‚‹ã˜ã‚ƒã‚“ã€‚`,
                    `ã¡ã£ã€${pieceName}ãŒã†ã–ã£ãŸã„ãªãã€‚`,
                    `ãã®${pieceName}ã€ã„ã„åƒãã™ã‚‹ã­ã€‚ãƒ ã‚«ã¤ãã‘ã©ã€‚`,
                    `ç‹æ‰‹ã‹â€¦${pieceName}ã®å‹•ãã€è­¦æˆ’ã—ã¦ãŸã®ã«ã€‚`
                ]));
            }
        } else if (move.flags.includes('c')) {
            const captured = pieceNamesMesu[move.captured];
            if (move.captured === 'q') {
                ui.msg.text(getRandom([
                    `ã‚ã‚ã£ï¼ ${pieceName}ã§ç§ã®${captured}ã‚’å–ã‚‹ãªã‚“ã¦â€¦ï¼ æœ€ä½ï¼`,
                    `å˜˜ã§ã—ã‚‡ï¼ï¼Ÿ ${pieceName}ã”ã¨ãã«${captured}ãŒâ€¦ï¼`,
                    `è¿”ã—ã¦ã‚ˆï¼ ç§ã®${captured}ï¼ ä¿¡ã˜ã‚‰ã‚Œãªã„ï¼`,
                    `ã†ã‚ã‚ã‚ã‚ã‚“ï¼ ${captured}ãŒæ­»ã‚“ã˜ã‚ƒã£ãŸãï¼`
                ]));
            } else if (state === "Winning") {
                ui.msg.text(getRandom([
                    `ã‚ãƒ¼ã‚ã€${pieceName}ã§${captured}å–ã£ã¡ã‚ƒã£ã¦ã€‚ç½ ãªã®ã«ï½—`,
                    `${captured}æ¬²ã—ã‹ã£ãŸã®ï¼Ÿ ${pieceName}ã‚’ãã‚“ãªæ‰€ã«å‹•ã‹ã—ã¦å¤§ä¸ˆå¤«ï¼Ÿ`,
                    `ãã®${captured}ã¯ã‚¨ã‚µã ã‚ˆï¼Ÿ ${pieceName}ãŒå­¤ç«‹ã—ã¡ã‚ƒã†ã­ï½—`,
                    `å®‰ã„${captured}ã‚’å–ã‚‹ãŸã‚ã«${pieceName}ã‚’ä½¿ã†ã‚“ã ã€‚ã¸ã‡ã€œï½—`
                ]));
            } else {
                ui.msg.text(getRandom([
                    `ç—›ã£â€¦${pieceName}ã§${captured}ã‚’å–ã‚‹ãªã‚“ã¦ã€è¨ˆç®—å¤–â€¦ã€‚`,
                    `ãã£ã€${captured}ãŒã‚„ã‚‰ã‚ŒãŸâ€¦${pieceName}ã®å‹•ãã€é‹­ã„ã­ã€‚`,
                    `å¤§äº‹ã«ã—ã¦ãŸ${captured}ãŒâ€¦${pieceName}ã€è¨±ã•ãªã„ã‹ã‚‰ï¼`,
                    `ã‚„ã‚‹ã­â€¦${pieceName}ã‚’æ´»ç”¨ã—ã¦${captured}ã‚’å–ã‚‹ãªã‚“ã¦ã€‚`
                ]));
            }
        } else if (move.flags.includes('k') || move.flags.includes('q')) {
            ui.msg.text(getRandom([
                `ã‚­ãƒ³ã‚°ã‚’å›²ã£ã¦é€ƒã’ãŸï¼Ÿ ${pieceName}ã¯è‡†ç—…ã ã­ã‡ã€œâ™¡`,
                `ã‚­ãƒ£ã‚¹ãƒªãƒ³ã‚°ã‹â€¦${pieceName}ã‚’å®ˆã‚‹ã®ã«å¿…æ­»ã ã­ï½—`,
                `å®‰å…¨åœ°å¸¯ã«${pieceName}ã‚’éš ã—ãŸã¤ã‚‚ã‚Šï¼Ÿ ã™ãå£Šã—ã¦ã‚ã’ã‚‹â™¡`,
                `ãµãƒ¼ã‚“ã€${pieceName}ã‚’å®ˆã‚Šã«å…¥ã£ãŸã‚“ã ã€‚ã¤ã¾ã‚“ãªã„ã®ã€‚`
            ]));
        } else if (move.flags.includes('p')) {
            ui.msg.text(getRandom([
                `ã’ã£ã€${pieceName}ãŒæ˜‡æ ¼ï¼ï¼Ÿ ç”Ÿæ„æ°—ã™ãã‚‹ï¼`,
                `ãƒãƒ¼ãƒ³ã®åˆ†éš›ã§ã‚¯ã‚¤ãƒ¼ãƒ³ã«æˆã‚‹ãªã‚“ã¦â€¦${pieceName}ã®ãã›ã«ï¼`,
                `ã¡ã‚‡ã£ã¨ã€ãã®${pieceName}ã¯èã„ã¦ãªã„ï¼ åå‰‡ã˜ã‚ƒãªã„ã®ï¼ï¼Ÿ`,
                `èª¿å­ã«ä¹—ã£ã¦${pieceName}ã‚’é€²åŒ–ã•ã›ã¡ã‚ƒã£ã¦â€¦æ½°ã—ã¦ã‚„ã‚‹ï¼`
            ]));
        } else {
            // é€šå¸¸ç§»å‹•ã®è§£èª¬ï¼ˆé§’ã”ã¨ã®åˆ†å²ï¼‰
            const phrases = {
                'p': [
                    `${pieceName}ã‚’ã¡ã‚‡ã“ã¡ã‚‡ã“é€²ã‚ã¦â€¦å¯æ„›ã„ã­ã‡ï½—`,
                    `ãã®${pieceName}ã€é€²ã‚ã¦ä½•ã«ãªã‚‹ã®ï¼Ÿ ã·ã·ã£`,
                    `ã˜ã‚ã˜ã‚${pieceName}ã§æ”»ã‚ã‚‹æ°—ï¼Ÿ æ€§æ ¼æš—ãã†ï½—`
                ],
                'n': [
                    `${pieceName}ãŒãƒ”ãƒ§ãƒ³ãƒ”ãƒ§ãƒ³è·³ã­ã¦â€¦ã†ã–ã„å‹•ãã ãªãã€‚`,
                    `ãã®${pieceName}ã®å‹•ãã€ã¡ã‚‡ã£ã¨èª­ã¿ã¥ã‚‰ã„ã‹ã‚‚â€¦ã€‚`,
                    `å¤‰ãªå‹•ãã®${pieceName}ã ã­ã€‚é¦¬é¹¿ã«ã—ã¦ã‚‹ï¼Ÿ`
                ],
                'b': [
                    `æ–œã‚ã‹ã‚‰${pieceName}ã§ç‹™ã£ã¦ã‚‹ï¼Ÿ ãƒãƒ¬ãƒãƒ¬ã ã‚ˆã€œï½—`,
                    `ãã®${pieceName}ã€é ãã‹ã‚‰è¦–ç·šã‚’æ„Ÿã˜ã‚‹ã‚ã­â€¦ã€‚`,
                    `${pieceName}ã‚’ã‚¹ãƒƒã¨é€šã—ã¦ããŸã‹ã€‚`
                ],
                'r': [
                    `ç¸¦æ¨ªç„¡å°½ã«${pieceName}ã‚’å‹•ã‹ã™æ°—ï¼Ÿ å˜ç´”ã ã­ã‡ã€‚`,
                    `${pieceName}ã®çªç ´åŠ›ã«é ¼ã£ã¡ã‚ƒã£ã¦ã€‚è„³ç­‹ï¼Ÿ`,
                    `ãã®${pieceName}ã€å£ã¿ãŸã„ã§é‚ªé­”ãã•ã„ãªãã€‚`
                ],
                'q': [
                    `å‡ºãŸã€${pieceName}é ¼ã¿ï¼ åˆå¿ƒè€…ã‚ã‚‹ã‚ã‚‹ã ã­ï½—`,
                    `æœ€å¼·ã®${pieceName}ã‚’å‹•ã‹ã—ã¦æº€è¶³ï¼Ÿ`,
                    `ãã®${pieceName}ã€æš´ã‚Œã•ã›ãªã„ã‹ã‚‰ã­ã€‚`
                ],
                'k': [
                    `ç‹æ§˜ï¼ˆ${pieceName}ï¼‰è‡ªã‚‰ãŠæ•£æ­©ï¼Ÿ ä½™è£•ãªã„ã­ã‡ï½—`,
                    `${pieceName}ãŒé€ƒã’å›ã£ã¦ã‚‹ï½— ã¿ã£ã¨ã‚‚ãªã„ã‚ˆï¼Ÿ`,
                    `ãã‚“ãªæ‰€ã«${pieceName}å‹•ã‹ã—ã¦å¤§ä¸ˆå¤«ã€œï¼Ÿ`
                ]
            };
            const pList = phrases[move.piece] || phrases['p'];

            if (state === "Winning") {
               ui.msg.text(getRandom(pList.map(s => s + " ç„¡é§„ãªã‚ãŒãã ã‘ã©ã­ï¼")));
            } else if (state === "Losing") {
               ui.msg.text(getRandom([
                   `ãã£â€¦ãã®${pieceName}ã®å‹•ãã€å«Œãªäºˆæ„ŸãŒã™ã‚‹â€¦ã€‚`,
                   `ãªã€ä½•ãã®${pieceName}ã®æ‰‹â€¦èª­ã‚“ã§ãªã‹ã£ãŸâ€¦`,
                   `ã†ã…â€¦${pieceName}ãŒè¿«ã£ã¦ãã‚‹â€¦ãƒ—ãƒ¬ãƒƒã‚·ãƒ£ãƒ¼ã‹ã‘ãªã„ã§ã‚ˆâ€¦`
               ]));
            } else {
               ui.msg.text(getRandom(pList));
            }
        }
    } 
    // --- AIå´ï¼ˆæ•µï¼‰ãŒå‹•ã‹ã—ãŸæ™‚ ---
    else {
        if (game.in_check()) {
             if (state === "Losing") {
                 ui.msg.text(getRandom([
                     `ã“ã‚Œãªã‚‰ã©ã†ï¼ï¼Ÿ ${pieceName}ã§èµ·æ­»å›ç”Ÿã®ç‹æ‰‹ï¼`,
                     `ãŠé¡˜ã„ï¼ ${pieceName}ã®æ”»æ’ƒã€å½“ãŸã£ã¦ï¼`,
                     `ãã‚‰ãˆï¼ ${pieceName}ã«ã‚ˆã‚‹å¿…æ®ºã®ç‹æ‰‹ï¼`,
                     `ã‚‚ã†ãƒ¤ã‚±ã‚¯ã‚½ã ã‚ˆï¼ ${pieceName}ã§ç‰¹æ”»ï¼`
                 ]));
             } else {
                 ui.msg.text(getRandom([
                     `ã»ã‚‰ã»ã‚‰ã€${pieceName}ã§ç‹æ‰‹ã ã‚ˆã€œâ™¡ é€ƒã’ãªãã‚ƒçµ‚ã‚ã‚‹ã‚ˆï¼Ÿ`,
                     `${pieceName}ãŒç‹æ§˜ã®å–‰å…ƒã«ãƒŠã‚¤ãƒ•çªãã¤ã‘ã¦ã‚‹ã‚ˆï¼Ÿï½—`,
                     `ã‚­ãƒ£ãƒãƒï¼ ${pieceName}ã«è¿½ã„è©°ã‚ã‚‰ã‚Œã¦æƒ¨ã‚ã€œï½—`,
                     `ã•ãã€${pieceName}ã‹ã‚‰ã©ã†é€ƒã’ã‚‹ï¼Ÿ æ³£ã„ã¦è¬ã‚‹ãªã‚‰è¨±ã™ã‹ã‚‚ï¼Ÿ`
                 ]));
             }
        } else if (move.flags.includes('c')) {
            const captured = pieceNamesMesu[move.captured];
             if (move.captured === 'q') {
                 ui.msg.text(getRandom([
                     `ã‚„ã£ãŸï¼ ã‚ã‚“ãŸã®${captured}ã€ç§ã®${pieceName}ã§ã„ãŸã ã„ã¡ã‚ƒã£ãŸã€œâ™¡`,
                     `æœ€å¼·ã®${captured}ãŒã„ãªããªã£ã¦ã©ã‚“ãªæ°—æŒã¡ã€œï¼Ÿ ç§ã®${pieceName}ã™ã”ã„ã§ã—ã‚‡ï¼`,
                     `${pieceName}ã§${captured}ã‚’æ’ƒç ´ï¼ ã‚‚ã†å‹è² ã‚ã‚Šã ã­ï¼`,
                     `ã‚ãƒ¼ã‚ã€å¤§äº‹ãª${captured}ã‚’${pieceName}ã«æ§ã’ã¡ã‚ƒã†ãªã‚“ã¦ï½—`
                 ]));
             } else {
                 ui.msg.text(getRandom([
                     `é æ…®ãªã${captured}ã‚’${pieceName}ã§ç‹©ã‚‹ã­ã€‚éš™ã ã‚‰ã‘ãªã‚“ã ã‚‚ã‚“ï½—`,
                     `ã„ãŸã ãã€œï¼ ${pieceName}ã®ã”é£¯ã«ãªã£ã¡ã‚ƒã£ãŸã­ã€${captured}ã•ã‚“ï½—`,
                     `${captured}ã€ãŠã„ã—ã„ã§ã™â™¡ ${pieceName}ã‚‚å–œã‚“ã§ã‚‹ã‚ˆï¼`,
                     `ãŠæƒé™¤å®Œäº†ã€œï¼ é‚ªé­”ãª${captured}ã¯${pieceName}ãŒæ¶ˆã—ã¡ã‚ƒã„ã¾ã—ãŸï¼`
                 ]));
             }
        } else if (move.flags.includes('p')) {
            ui.msg.text(getRandom([
                `è¦‹ã¦è¦‹ã¦ï¼ ç§ã®${pieceName}ãŒæœ€å¼·ã®ã‚¯ã‚¤ãƒ¼ãƒ³ã«ãªã£ã¡ã‚ƒã£ãŸâ™¡`,
                `ã“ã‚ŒãŒ${pieceName}ã®çœŸã®å§¿ï¼ çµ¶æœ›ã—ãªã•ã„ï¼`,
                `é€²åŒ–ã€œï¼ ã“ã®${pieceName}ã¯ã‚‚ã†èª°ã«ã‚‚æ­¢ã‚ã‚‰ã‚Œãªã„ã‚ˆã­ã€œï½—`,
                `ã¯ã„æœ€å¼·ã€œã€‚${pieceName}ãŒã‚¯ã‚¤ãƒ¼ãƒ³ã«ãªã£ãŸæ™‚ç‚¹ã§è©°ã¿ã ã‚ˆï¼Ÿ`
            ]));
        } else {
            // AIã®ç‹™ã„ã‚’è§£èª¬é¢¨ã«ï¼ˆé§’ã”ã¨ã®åˆ†å²ï¼‰
             const phrasesAi = {
                'p': [
                    `ç§ã®${pieceName}ã‚’é€²ã‚ã¦ã‚ã’ã‚‹ã€‚ã˜ã‚ã˜ã‚è‹¦ã—ã‚“ã§ã­â™¡`,
                    `ã»ã‚‰ã€${pieceName}ãŒè¿‘ã¥ã„ã¦ã„ãã‚ˆã€œã€‚æ€–ã„ï¼Ÿ`,
                    `ã“ã®${pieceName}ãŒå°†æ¥åŒ–ã‘ã‚‹ã‚“ã ã‹ã‚‰ã€‚è¦šãˆã¨ããªã‚ˆï¼Ÿ`
                ],
                'n': [
                    `è¯éº—ãªã‚‹${pieceName}ã®ã‚¸ãƒ£ãƒ³ãƒ—ï¼ äºˆæ¸¬ã§ãã‚‹ã‹ãªï¼Ÿ`,
                    `ç§ã®${pieceName}ã¯ãƒˆãƒªãƒƒã‚­ãƒ¼ã ã‚ˆã€œã€‚ã¤ã„ã¦ã“ã‚Œã‚‹ï¼Ÿ`,
                    `ãµãµã£ã€ã“ã®${pieceName}ã®ä½ç½®ã€çµ¶å¦™ã§ã—ã‚‡ï¼Ÿ`
                ],
                'b': [
                    `é è·é›¢ã‹ã‚‰${pieceName}ã§ãƒ­ãƒƒã‚¯ã‚ªãƒ³å®Œäº†â™¡`,
                    `æ­»è§’ã‹ã‚‰${pieceName}ãŒã“ã‚“ã«ã¡ã¯ï¼`,
                    `ã“ã®${pieceName}ã®å°„ç·šã€è¦‹ãˆã¦ãªã‹ã£ãŸã§ã—ã‚‡ï¼Ÿ`
                ],
                'r': [
                    `ãƒ‰ã‚«ãƒ¼ãƒ³ã¨${pieceName}ã‚’é€²ã‚ã‚‹ã‚ˆï¼ é“ã‚’é–‹ã‘ãªã•ã„ï¼`,
                    `ç§ã®${pieceName}ã¯é‡æˆ¦è»Šãªã®ã€‚æ­¢ã‚ã‚‰ã‚Œãªã„ã‚ˆï¼Ÿ`,
                    `ã“ã®åˆ—ã¯${pieceName}ãŒåˆ¶åœ§ã—ãŸã‹ã‚‰ã€‚`
                ],
                'q': [
                    `æœ€å¼·ã®${pieceName}ãŒãŠå‡ºã¾ã—ã ï¼ ã²ã‚Œä¼ã—ãªã•ã„ï¼`,
                    `ç§ã®${pieceName}ã«å‹ã¦ã‚‹ã¨æ€ã£ã¦ã‚‹ï¼Ÿ`,
                    `ã•ã‚ã€${pieceName}ã§è¹‚èº™ã—ã¦ã‚ã’ã‚‹â™¡`
                ],
                'k': [
                    `ç‹æ§˜ï¼ˆ${pieceName}ï¼‰ã¯é«˜ã¿ã®è¦‹ç‰©ã¨ã„ã“ã†ã‹ãªã€‚`,
                    `å®‰å…¨ãªå ´æ‰€ã«${pieceName}ã‚’ç§»å‹•ã£ã¨ã€‚`,
                    `ãµãµã‚“ã€${pieceName}ã¯æ•ã¾ã‚‰ãªã„ã‚ˆã€œã€‚`
                ]
            };
            const pListAi = phrasesAi[move.piece] || phrasesAi['p'];

            if (state === "Winning") {
                ui.msg.text(getRandom(pListAi.map(s => s + " å®Œç’§ã™ãã¦æ€–ã„ï¼Ÿ")));
            } else if (state === "Losing") {
                ui.msg.text(getRandom([
                    `ã¨ã€ã¨ã‚Šã‚ãˆãš${pieceName}ã§æ§˜å­è¦‹ã‹ãªâ€¦ã€‚æ²¹æ–­ã—ãªã„ã§ã‚ˆã­ï¼`,
                    `ã¾ã è² ã‘ã¦ãªã„ã—ï¼ ${pieceName}ã‚’ä¿¡ã˜ã¦ã‚‹ã—ï¼`,
                    `ãªã‚“ã¨ã‹${pieceName}ã§é€†è»¢ã®ç³¸å£ã‚’â€¦ï¼`
                ]));
            } else {
                ui.msg.text(getRandom(pListAi));
            }
        }
    }
}

// === é¡”ãƒ»ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°ãƒ­ã‚¸ãƒƒã‚¯ ===
function updateStatus(lastMove) {
  const rawScore = getBoardValue(game);
  const aiScore = getAiScore();
  const aiState = getAiState(aiScore);

  // 1. ã‚²ãƒ¼ã‚¸æ›´æ–°
  const pct = (1 / (1 + Math.exp(-rawScore / 500))) * 100;
  ui.evalWhite.css('width', pct + '%');
    
  const isMyTurn = (game.turn() === playerColor);
    
  if (isMyTurn) ui.face.addClass('active-turn');
  else ui.face.removeClass('active-turn');

  // A. ã‚²ãƒ¼ãƒ çµ‚äº†æ™‚
  if(game.game_over()) {
    ui.btnRetry.removeClass('hidden'); ui.btnAuto.hide(); ui.btnHint.hide(); ui.btnUndo.hide();
      
    if(game.in_checkmate()) {
        const playerLost = (game.turn() === playerColor);
        if (playerLost) {
            ui.status.text("ã‚ãªãŸã®è² ã‘ (ã–ãã“â™¡)");
            ui.msg.html(getRandomMsg('win')); 
            ui.face.text(getRandom(EMOJI_WINNING));
            triggerVib('lose'); // æ•—åŒ—æŒ¯å‹•
        } else {
            ui.status.text("ã‚ãªãŸã®å‹ã¡ï¼(å‚ã‚Šã¾ã—ãŸ)");
            ui.msg.html(getRandomMsg('lose')); 
            ui.face.text(getRandom(EMOJI_LOSING));
            shootConfetti(); 
            playSound('win'); 
            triggerVib('win'); // å‹åˆ©æŒ¯å‹•
        }
    } else {
        ui.status.text("å¼•ãåˆ†ã‘");
        ui.msg.text(getRandomMsg('draw'));
        ui.face.text(getRandom(EMOJI_NORMAL));
    }
    return;
  }
    
  ui.status.text(isMyTurn ? "ã‚ãªãŸã®ç•ª" : "ç›¸æ‰‹ã®ç•ª");
  if(board) board.draggable = (isMyTurn && !isAuto && !game.game_over());

  // B. ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼æ‰‹ç•ªä¸­
  if (isMyTurn) {
      if (game.in_check()) {
          ui.face.text(EMOJI_SCARED);
          ui.boardWrap.addClass('in-check-danger');
          triggerVib('check'); // ç‹æ‰‹æŒ¯å‹•
      } else {
          ui.face.text(isAuto ? EMOJI_ROBOT : EMOJI_SELF);
          ui.boardWrap.removeClass('in-check-danger');
      }
      return;
  }

  // C. AIã®æ‰‹ç•ª
  ui.boardWrap.removeClass('in-check-danger');

  if (aiState === "Losing") {
      ui.face.text(getRandom(EMOJI_LOSING)); 
      return;
  }
  if (aiState === "Winning") {
      ui.face.text(getRandom(EMOJI_WINNING)); 
      return;
  }

  if (lastMove) {
      const isPlayerJustMoved = (lastMove.color === playerColor);
      if (isPlayerJustMoved) {
          if (game.in_check()) {
               ui.face.text("ğŸ˜µâ€ğŸ’«"); 
               ui.boardWrap.addClass('in-check-danger');
               triggerVib('check'); // ç‹æ‰‹æŒ¯å‹•
               return;
          }
          if (lastMove.flags.includes('c')) {
               ui.face.text("ğŸ˜ "); 
               return;
          }
      }
  }
  ui.face.text(getRandom(EMOJI_NORMAL));
}

function toggleAutoPlay() {
  if(game.game_over()) return;
  isAuto = !isAuto;
    
  if(isAuto) {
    removeHighlights();
    ui.btnHint.prop('disabled', true).addClass('btn-disabled');
    ui.btnUndo.prop('disabled', true).addClass('btn-disabled');
    ui.btnAuto.addClass('btn-auto-active').text("ğŸ¤– ã‚ªãƒ¼ãƒˆ: ON"); 
    ui.msg.text(getRandomMsg('autoOn'));
    gameLoop();
  } else {
    ui.btnHint.prop('disabled', false).removeClass('btn-disabled');
    ui.btnUndo.prop('disabled', false).removeClass('btn-disabled');
    ui.btnAuto.removeClass('btn-auto-active').text("ğŸ¤– ã‚ªãƒ¼ãƒˆ: OFF"); 
    clearTimeout(autoTimer);
    if (game.turn() === playerColor) {
        ui.msg.text("ã‚„ã£ã¨è‡ªåˆ†ã§ã‚„ã‚‹æ°—ã«ãªã£ãŸï¼Ÿ");
    } else {
        ui.msg.text("ç§ã®ç•ªã ã‘ã©ï¼Ÿ");
    }
    if(game.turn() !== playerColor) {
       gameLoop(); 
    }
    updateStatus(null);
  }
}

function undoMove() {
  if(!isAuto && !game.game_over() && game.turn()===playerColor && game.history().length>=2) {
    game.undo(); game.undo(); 
    board.position(game.fen()); 
    removeHighlights();
    $('.highlight-danger-source').removeClass('highlight-danger-source'); 
    ui.msg.text(getRandomMsg('undo')); 
    updateStatus(null);
  }
}

function showHint() {
  if(game.turn()!==playerColor || isAuto) return;
  ui.msg.text("ãƒ’ãƒ³ãƒˆï¼Ÿ ã—ã‚‡ã†ãŒãªã„ãªã...");
  setTimeout(() => {
      const m = getBestMove(3); 
      if(m) {
          const obj = game.move(m); game.undo();
          $('#board .square-'+obj.from).addClass('highlight-hint');
          $('#board .square-'+obj.to).addClass('highlight-hint');
          ui.msg.text(getRandomMsg('hint'));
      }
  }, 100);
}

function removeHighlights() {
  $('#board [class*="square"]').removeClass('highlight-move highlight-capture highlight-hint');
}
</script>
<script defer src="https://static.cloudflareinsights.com/beacon.min.js/vcd15cbe7772f49c399c6a5babf22c1241717689176015" integrity="sha512-ZpsOmlRQV6y907TI0dKBHq9Md29nnaEIPlkf84rnaERnq6zvWvPUqr2ft8M1aS28oN72PdrCzSjY4U6VaAw1EQ==" data-cf-beacon='{"version":"2024.11.0","token":"119f2fbc921941548be538fc51023465","r":1,"server_timing":{"name":{"cfCacheStatus":true,"cfEdge":true,"cfExtPri":true,"cfL4":true,"cfOrigin":true,"cfSpeedBrain":true},"location_startswith":null}}' crossorigin="anonymous"></script>
</body>
</html>