<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>AI Chess - Mesugaki Ultimate (Revised)</title>

<link rel="stylesheet" href="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.css">

<style>
  /* === å…¨ä½“è¨­å®š === */
  body {
    /* ä½™ç™½ã‚’ãƒªã‚»ãƒƒãƒˆ */
    margin: 0;
    /* ãƒ•ã‚©ãƒ³ãƒˆè¨­å®šï¼ˆè¦‹ã‚„ã™ã„ã‚´ã‚·ãƒƒã‚¯ä½“ï¼‰ */
    font-family: 'Helvetica Neue', Arial, sans-serif;
    /* èƒŒæ™¯è‰²ï¼ˆè½ã¡ç€ã„ãŸã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ï¼‰ */
    background: linear-gradient(135deg, #134E5E, #71B280);
    /* ç”»é¢ã®é«˜ã•ã„ã£ã±ã„ã«è¡¨ç¤º */
    min-height: 100vh;
    /* Flexboxã§ä¸­å¤®æƒãˆã«ã™ã‚‹ */
    display: flex;
    justify-content: center;
    align-items: center;
    /* æ–‡å­—è‰²ã¯ç™½ */
    color: #fff;
    /* ä¸Šä¸‹ã®å†…å´ä½™ç™½ */
    padding: 20px 0;
    /* ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ã‚’å«ã‚ãŸã‚µã‚¤ã‚ºè¨ˆç®— */
    box-sizing: border-box;
  }

  /* === ãƒ¡ã‚¤ãƒ³ã®ã‚³ãƒ³ãƒ†ãƒŠãƒœãƒƒã‚¯ã‚¹ === */
  .box {
    /* èƒŒæ™¯ã¯ç™½ã®åŠé€æ˜ */
    background: rgba(255, 255, 255, 0.95);
    /* æ–‡å­—è‰²ã¯æ¿ƒã„ã‚°ãƒ¬ãƒ¼ */
    color: #333;
    /* å†…å´ã®ä½™ç™½ */
    padding: 20px;
    /* è§’ã‚’ä¸¸ãã™ã‚‹ */
    border-radius: 15px;
    /* å¼·ã„å½±ã‚’ã¤ã‘ã¦æµ®ã„ã¦ã„ã‚‹ã‚ˆã†ã«è¦‹ã›ã‚‹ */
    box-shadow: 0 20px 50px rgba(0,0,0,0.5);
    /* Flexboxã§å·¦å³ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ */
    display: flex;
    /* è¦ç´ é–“ã®éš™é–“ */
    gap: 25px;
    /* æœ€å¤§å¹… */
    max-width: 950px;
    /* å¹…ã¯ç”»é¢ã®95% */
    width: 95%;
    /* é«˜ã•ã¯è‡ªå‹• */
    height: auto;
    /* ä¸­å¤®é…ç½® */
    margin: auto;
    /* ç›¸å¯¾é…ç½®ï¼ˆã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ç”¨ï¼‰ */
    position: relative;
    /* ã‚µã‚¤ã‚ºè¨ˆç®—ã®æŒ‡å®š */
    box-sizing: border-box;
  }

  /* === ç›¤é¢ã‚¨ãƒªã‚¢ === */
  .board-section {
    /* å·¦å´ï¼ˆç›¤é¢ï¼‰ã®æ¯”ç‡ã‚’å¤§ãã */
    flex: 2;
    /* Flexboxè¨­å®š */
    display: flex;
    /* ç¸¦ä¸¦ã³ */
    flex-direction: column;
    /* ä¸­å¤®æƒãˆ */
    justify-content: center;
    align-items: center;
  }
  .board-wrap {
    /* ç›¤é¢ã®æ ç·šï¼ˆç·‘è‰²ï¼‰ */
    border: 5px solid #2E7D32;
    /* è§’ä¸¸ */
    border-radius: 4px;
    /* å½±ã‚’ã¤ã‘ã¦ç«‹ä½“æ„Ÿã‚’å‡ºã™ */
    box-shadow: 0 10px 30px rgba(0,0,0,0.4);
    /* å¹…ã„ã£ã±ã„ */
    width: 100%;
    /* æœ€å¤§å¹…åˆ¶é™ */
    max-width: 600px;
    /* æ­£æ–¹å½¢ã‚’ä¿ã¤ */
    aspect-ratio: 1 / 1;
    /* ç›¸å¯¾é…ç½® */
    position: relative;
    /* çŠ¶æ…‹å¤‰åŒ–æ™‚ã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
    transition: box-shadow 0.3s, border-color 0.3s;
  }
    
  /* ç‹æ‰‹ï¼ˆãƒã‚§ãƒƒã‚¯ï¼‰æ™‚ã®èµ¤æ æ¼”å‡º */
  .in-check-danger {
    /* èµ¤è‰²ã«å¤‰æ›´ï¼ˆå„ªå…ˆåº¦é«˜ï¼‰ */
    border-color: #c0392b !important; 
    /* èµ¤ã„å…‰å½©ã‚’è¿½åŠ ï¼ˆå„ªå…ˆåº¦é«˜ï¼‰ */
    box-shadow: 0 0 25px rgba(192, 57, 43, 0.8) !important;
  }

  /* === æƒ…å ±ã‚¨ãƒªã‚¢ï¼ˆå³å´ï¼‰ === */
  .info-section {
    /* æ¯”ç‡ã¯å°ã•ã‚ */
    flex: 1;
    /* Flexboxè¨­å®š */
    display: flex;
    /* ç¸¦ä¸¦ã³ */
    flex-direction: column;
    /* ä¸­å¤®æƒãˆ */
    align-items: center;
    /* å†…å´ä½™ç™½ */
    padding: 10px;
  }

  /* === ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚¢ã‚¤ã‚³ãƒ³ === */
  .mascot {
    /* ãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚ºï¼ˆé¡”æ–‡å­—ã®å¤§ãã•ï¼‰ */
    font-size: 60px;
    /* èƒŒæ™¯ç™½ */
    background: #fff;
    /* ã‚µã‚¤ã‚ºå›ºå®š */
    width: 90px;
    height: 90px;
    /* çœŸã‚“ä¸¸ã«ã™ã‚‹ */
    border-radius: 50%;
    /* Flexboxã§é¡”æ–‡å­—ã‚’ä¸­å¤®ã¸ */
    display: flex;
    justify-content: center;
    align-items: center;
    /* æ ç·šï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯ã‚°ãƒ¬ãƒ¼ï¼‰ */
    border: 4px solid #ccc;
    /* ä¸‹ã®ä½™ç™½ */
    margin-bottom: 5px;
    /* ç¸®å°ã—ãªã„ã‚ˆã†ã«ã™ã‚‹ */
    flex-shrink: 0; 
    /* è»½ã„å½± */
    box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    /* ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ç”¨ */
    transition: 0.3s;
  }
    
  /* è‡ªåˆ†ã®ã‚¿ãƒ¼ãƒ³ã®æ™‚ã®æ¼”å‡ºï¼ˆç·‘ç™ºå…‰ï¼‰ */
  .active-turn {
    /* ç·‘è‰²ã®æ ç·š */
    border-color: #2ecc71 !important;
    /* ç·‘è‰²ã®ç™ºå…‰ */
    box-shadow: 0 0 25px rgba(46, 204, 113, 1.0) !important;
    /* å°‘ã—æ‹¡å¤§ */
    transform: scale(1.1);
  }

  /* === å½¢å‹¢åˆ¤æ–­ã‚²ãƒ¼ã‚¸ === */
  .eval-gauge-container {
    /* å¹…ã„ã£ã±ã„ */
    width: 100%;
    /* é«˜ã• */
    height: 10px;
    /* èƒŒæ™¯è‰²ï¼ˆãƒ€ãƒ¼ã‚¯ã‚°ãƒ¬ãƒ¼ï¼‰ */
    background: #555;
    /* ä¸‹ä½™ç™½ */
    margin-bottom: 15px;
    /* è§’ä¸¸ */
    border-radius: 4px;
    /* ã¯ã¿å‡ºã—éè¡¨ç¤º */
    overflow: hidden;
    /* æ¨ªä¸¦ã³ */
    display: flex;
    /* å†…å´ã®å½± */
    box-shadow: inset 0 1px 3px rgba(0,0,0,0.3);
  }
  /* ç™½å´ã®ãƒãƒ¼ï¼ˆæœ‰åˆ©ãªã»ã©ä¼¸ã³ã‚‹ï¼‰ */
  .eval-bar-white { height: 100%; background: #2ecc71; width: 50%; transition: width 0.5s ease-out; }
  /* é»’å´ã®ãƒãƒ¼ï¼ˆèƒŒæ™¯è‰²ã§è¡¨ç¾ã™ã‚‹ãŸã‚å®Ÿè³ªæœªä½¿ç”¨ã ãŒãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆç”¨ã«é…ç½®ï¼‰ */
  .eval-bar-black { height: 100%; background: #e74c3c; width: 50%; }

  /* === å¹ãå‡ºã— & ãƒ«ãƒ¼ãƒ« === */
  .bubble {
    /* ç›¸å¯¾é…ç½® */
    position: relative;
    /* èƒŒæ™¯è–„ã„ã‚°ãƒ¬ãƒ¼ */
    background: #ecf0f1;
    /* æ–‡å­—è‰²æ¿ƒã„ç´º */
    color: #2c3e50;
    /* è§’ä¸¸ */
    border-radius: 12px;
    /* å†…å´ä½™ç™½ */
    padding: 15px;
    /* å¹…ã„ã£ã±ã„ */
    width: 100%;
    /* ä¸‹ä½™ç™½ */
    margin-bottom: 15px;
    /* æœ€ä½é«˜ã•ç¢ºä¿ */
    min-height: 80px; 
    /* ãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚º */
    font-size: 14px;
    /* ã‚µã‚¤ã‚ºè¨ˆç®— */
    box-sizing: border-box;
    /* æ ç·š */
    border: 2px solid #bdc3c7;
    /* Flexboxã§æ–‡å­—ä¸­å¤® */
    display: flex;
    align-items: center;
    justify-content: center;
    /* ãƒ†ã‚­ã‚¹ãƒˆä¸­å¤®æƒãˆ */
    text-align: center;
    /* å¤ªå­— */
    font-weight: bold;
  }
  /* å¹ãå‡ºã—ã®ã—ã£ã½ï¼ˆä¸Šå‘ãï¼‰ */
  .bubble::after {
    /* ç©ºã‚³ãƒ³ãƒ†ãƒ³ãƒ„ */
    content: '';
    /* çµ¶å¯¾é…ç½® */
    position: absolute;
    /* ä¸Šã«ã¯ã¿å‡ºã•ã›ã‚‹ */
    top: -12px;
    /* å·¦å³ä¸­å¤® */
    left: 50%;
    /* ä¸­å¤®è£œæ­£ */
    transform: translateX(-50%);
    /* ä¸‰è§’å½¢ã‚’ä½œã‚‹è¨­å®š */
    border: 12px solid transparent;
    border-bottom-color: #bdc3c7;
  }
      
  /* ãƒ«ãƒ¼ãƒ«èª¬æ˜ã‚¨ãƒªã‚¢ */
  .sidebar-rules {
    /* å¹…ã„ã£ã±ã„ */
    width: 100%;
    /* èƒŒæ™¯è–„ã„ç·‘ */
    background: #f1f8e9;
    /* æ ç·šç·‘ */
    border: 1px solid #c5e1a5;
    /* è§’ä¸¸ */
    border-radius: 8px;
    /* ä½™ç™½ */
    padding: 10px;
    /* ä¸‹ä½™ç™½ */
    margin-bottom: 10px;
    /* æ–‡å­—å°ã•ã‚ */
    font-size: 0.8em;
    /* æ–‡å­—è‰²ç·‘ */
    color: #33691e;
    /* ã‚µã‚¤ã‚ºè¨ˆç®— */
    box-sizing: border-box;
    /* å·¦æƒãˆ */
    text-align: left;
    /* é«˜ã•åˆ¶é™ */
    max-height: 250px;
    /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«è¨±å¯ */
    overflow-y: auto;
  }
  /* ãƒ«ãƒ¼ãƒ«ã®è¦‹å‡ºã— */
  .sidebar-rules h4 { margin: 0 0 5px 0; border-bottom: 1px solid #aed581; padding-bottom: 3px; }
  /* ãƒªã‚¹ãƒˆè¨­å®š */
  .sidebar-rules ul { margin: 0; padding-left: 20px; }
  .sidebar-rules li { margin-bottom: 3px; }

  /* === ãƒœã‚¿ãƒ³é¡ === */
  .btn-group { 
    /* å¹…ã„ã£ã±ã„ */
    width: 100%; 
    /* ç¸¦ä¸¦ã³ */
    display: flex; flex-direction: column; 
    /* ãƒœã‚¿ãƒ³é–“ã®éš™é–“ */
    gap: 8px; 
    /* ä¸‹å¯„ã› */
    margin-top: auto; 
  }
  .btn {
    /* æ ç·šãªã— */
    border: none; 
    /* ä½™ç™½ */
    padding: 12px; 
    /* è§’ä¸¸ */
    border-radius: 8px; 
    /* å¤ªå­— */
    font-weight: bold; 
    /* ã‚«ãƒ¼ã‚½ãƒ«æŒ‡ */
    cursor: pointer; 
    /* å¹…ã„ã£ã±ã„ */
    width: 100%; 
    /* æ–‡å­—ç™½ */
    color: white; 
    /* ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
    transition: 0.2s; 
    /* æ–‡å­—ã‚µã‚¤ã‚º */
    font-size: 14px;
  }
  /* å„ãƒœã‚¿ãƒ³ã®è‰²è¨­å®š */
  .btn-hint { background: #e67e22; } .btn-hint:hover { background: #d35400; }
  .btn-undo { background: #9b59b6; } .btn-undo:hover { background: #8e44ad; } 
  .btn-auto { background: #2ecc71; } .btn-auto:hover { background: #27ae60; }
  .btn-auto-active { background: #e74c3c !important; } /* ã‚ªãƒ¼ãƒˆONæ™‚ã¯èµ¤ */
  .btn-retry { background: #3498db; } .btn-retry:hover { background: #2980b9; }
  .btn-reset { background: #95a5a6; } .btn-reset:hover { background: #7f8c8d; }
  /* ç„¡åŠ¹åŒ–ãƒœã‚¿ãƒ³ */
  .btn-disabled { background: #bdc3c7 !important; cursor: not-allowed; opacity: 0.6; }
  /* éè¡¨ç¤ºç”¨ã‚¯ãƒ©ã‚¹ */
  .hidden { display: none !important; }

  /* === ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ï¼ˆãƒ¡ãƒ‹ãƒ¥ãƒ¼ç”»é¢ï¼‰ === */
  .overlay {
    /* çµ¶å¯¾é…ç½®ã§å…¨ä½“ã‚’è¦†ã† */
    position: absolute; top: 0; left: 0; width: 100%; height: 100%;
    /* èƒŒæ™¯è‰²ï¼ˆæ¿ƒã„ç·‘ã®åŠé€æ˜ï¼‰ */
    background: rgba(20, 50, 30, 0.98); 
    /* æœ€å‰é¢ */
    z-index: 100; 
    /* Flexboxã§ä¸­å¤®æƒãˆ */
    display: flex; 
    flex-direction: column; justify-content: center; align-items: center; 
    /* æ–‡å­—ç™½ */
    color: #fff; 
    /* è§’ä¸¸ */
    border-radius: 15px; 
    /* ä½™ç™½ */
    padding: 20px; 
    /* ã‚µã‚¤ã‚ºè¨ˆç®— */
    box-sizing: border-box;
  }
  /* ã‚¹ã‚¿ãƒ¼ãƒˆãƒœã‚¿ãƒ³ */
  .menu-btn {
    /* ç·‘èƒŒæ™¯ */
    background: #2ecc71; color: #fff; font-weight: bold; cursor: pointer; margin-top: 30px;
    padding: 15px 30px; font-size: 18px; border:none; border-radius: 5px; width: 100%;
  }

  /* === ç›¤é¢ã®ãƒã‚¤ãƒ©ã‚¤ãƒˆæ¼”å‡º === */
  /* ç§»å‹•å¯èƒ½ãƒã‚¹ï¼ˆç·‘ã®ãƒ‰ãƒƒãƒˆï¼‰ */
  .highlight-move { background: radial-gradient(circle, rgba(46, 204, 113, 0.7) 20%, transparent 20%); }
  /* æ•µé§’ã‚’å–ã‚Œã‚‹ãƒã‚¹ï¼ˆèµ¤èƒŒæ™¯ï¼‰ */
  .highlight-capture { background-color: rgba(231, 76, 60, 0.5) !important; box-shadow: inset 0 0 0 4px rgba(192, 57, 43, 0.9) !important; }
    
  /* å±é™ºãªæ‰‹ï¼ˆã‚ªãƒ¬ãƒ³ã‚¸ï¼‰å¼·èª¿ */
  .highlight-danger-source { 
    /* æ¿ƒã„ã‚ªãƒ¬ãƒ³ã‚¸èƒŒæ™¯ */
    background-color: rgba(255, 120, 0, 0.85) !important; 
    /* å†…å´ã®å½±ã§å¼·èª¿ */
    box-shadow: inset 0 0 15px rgba(255, 50, 0, 0.8) !important; 
    /* ç‚¹æ»…ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
    animation: flash-orange 1.2s infinite alternate;
    /* å‰é¢è¡¨ç¤º */
    z-index: 10; 
  }
  /* ã‚ªãƒ¬ãƒ³ã‚¸ç‚¹æ»…å®šç¾© */
  @keyframes flash-orange { from { opacity: 0.8; } to { opacity: 1.0; } }

  /* ãƒ’ãƒ³ãƒˆè¡¨ç¤ºï¼ˆé»„è‰²ï¼‰ */
  .highlight-hint { 
    background: rgba(255, 235, 59, 0.7); 
    box-shadow: inset 0 0 10px rgba(255, 215, 0, 1.0); 
    /* é»„è‰²ç‚¹æ»… */
    animation: flash-yellow 0.8s infinite alternate; 
  }
  /* é»„è‰²ç‚¹æ»…å®šç¾© */
  @keyframes flash-yellow { from { opacity: 0.6; } to { opacity: 1.0; } }

  /* === ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–å¯¾å¿œï¼ˆã‚¹ãƒãƒ›å‘ã‘ï¼‰ === */
  @media(max-width:768px){
    /* ç¸¦ä¸¦ã³ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã«å¤‰æ›´ */
    body { align-items: flex-start; }
    .box { flex-direction: column; height: auto; width: 100%; border-radius: 0; padding: 10px; margin: 0; }
    /* æƒ…å ±ã‚¨ãƒªã‚¢ã‚’ä¸Šã¸ */
    .info-section { order: -1; width:100%; padding: 5px; } 
    /* ç›¤é¢ã‚’æœ€å¤§åŒ– */
    .board-wrap { width: 100%; max-width: 90vw; height: auto; aspect-ratio: 1/1; }
    /* ã‚¹ãƒãƒ›ã§ã¯ãƒ«ãƒ¼ãƒ«èª¬æ˜ã‚’éš ã™ */
    .sidebar-rules { display: none; }
  }
</style>
</head>
<body>

<div class="box">
  <div id="menu" class="overlay">
    <div style="width:100%; max-width:400px; text-align:center;">
      <h1 style="font-size:2.5em; margin:0 0 20px 0;">â™š AI Chess</h1>
      <a href="a10.html">Ver.0.1.0ã¸</a><a href="a115.html">Ver.1.1.5ã¸</a>
      <div style="display:flex; gap:20px; width:100%;">
        <div style="flex:1;">
          <p style="font-weight:bold;">è‰²</p>
          <select id="color-select" style="width:100%; padding:8px;">
              <option value="w">â™” å…ˆæ‰‹ (ç™½)</option>
              <option value="b">â™š å¾Œæ‰‹ (é»’)</option>
          </select>
        </div>
        <div style="flex:1;">
          <p style="font-weight:bold;">ãƒ¬ãƒ™ãƒ«</p>
          <select id="level" style="width:100%; padding:8px;">
            <option value="1">ğŸŒ± å…¥é–€ (é›‘é­š)</option>
            <option value="2">ğŸŒ² ä¸­ç´š (æ™®é€š)</option>
            <option value="3" selected>ğŸ‰ è¶…ç´š (æœ€å¼·)</option>
          </select>
        </div>
      </div>
      <button class="menu-btn" onclick="startGame()">ğŸ® ã‚²ãƒ¼ãƒ ã‚¹ã‚¿ãƒ¼ãƒˆï¼</button>
    </div>
  </div>

  <div class="board-section">
    <div class="board-wrap">
        <div id="board" style="width:100%"></div>
    </div>
  </div>

  <div class="info-section">
    <div class="mascot" id="face">ğŸ˜</div>
    <div class="eval-gauge-container">
        <div id="eval-bar-white" class="eval-bar-white"></div>
        <div id="eval-bar-black" class="eval-bar-black" style="background:#555; width:0;"></div>
    </div>
    <div id="status" style="font-weight:bold; margin-bottom:5px; font-size: 1.2em;">æº–å‚™ä¸­...</div>
    <div class="bubble" id="msg">è¨­å®šã‚’é¸ã‚“ã§ã‚¹ã‚¿ãƒ¼ãƒˆã—ã¦ã­ï¼</div>
    
    <div class="sidebar-rules">
        <h4>ğŸ“œ ã–ã“ã–ã“ãƒ«ãƒ¼ãƒ«</h4>
        <ul>
            <li>ç‹æ§˜(ã‚­ãƒ³ã‚°)ã‚’è©°ã¾ã›ã°å‹ã¡â™¥</li>
            <li>é§’ã¯ãƒ‰ãƒ©ãƒƒã‚°ã§å‹•ã‹ã—ã¦ã­ã€‚</li>
        </ul>
        <div style="font-size:0.9em; margin-top:5px; line-height:1.4;">
            <b>â™™ãƒãƒ¼ãƒ³</b>: å‰1æ­©ã€‚æ•µã¯æ–œã‚ã€‚<br>
            <b>â™˜ãƒŠã‚¤ãƒˆ</b>: Lå­—ã‚¸ãƒ£ãƒ³ãƒ—ã€‚<br>
            <b>â™—ãƒ“ã‚·ãƒ§ãƒƒãƒ—</b>: æ–œã‚ã€‚<br>
            <b>â™–ãƒ«ãƒ¼ã‚¯</b>: ç¸¦æ¨ªã€‚<br>
            <b>â™•ã‚¯ã‚¤ãƒ¼ãƒ³</b>: ç¸¦æ¨ªæ–œã‚ã€‚<br>
            <b>â™”ã‚­ãƒ³ã‚°</b>: å‘¨å›²1æ­©ã€‚
        </div>
    </div>

    <div class="btn-group">
      <button class="btn btn-hint" id="btn-hint" onclick="showHint()">ğŸ’¡ æœ€å¼·ãƒ’ãƒ³ãƒˆ</button>
      <button class="btn btn-undo" id="btn-undo" onclick="undoMove()">â†©ï¸ å¾…ã£ãŸ</button>
      <button class="btn btn-auto" id="btn-auto" onclick="toggleAutoPlay()">ğŸ¤– ã‚ªãƒ¼ãƒˆ: OFF</button>
      <button class="btn btn-retry hidden" id="btn-retry" onclick="startGame()">ğŸ”„ ã‚‚ã†ä¸€åº¦éŠã¶</button>
      <button class="btn btn-reset" onclick="location.reload()">ğŸ  ã‚¿ã‚¤ãƒˆãƒ«ã«æˆ»ã‚‹</button>
    </div>
  </div>
</div>

<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script src="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"></script>

<script>
// === ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°å®šç¾© ===
// ãƒã‚§ã‚¹ã®ã‚²ãƒ¼ãƒ ãƒ­ã‚¸ãƒƒã‚¯ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ä½œæˆ
const game = new Chess();
// ãƒœãƒ¼ãƒ‰UIã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ï¼ˆå¾Œã§åˆæœŸåŒ–ï¼‰
let board = null;
// AIã®å¼·ã•ãƒ¬ãƒ™ãƒ«ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ3ï¼‰
let aiLevel = 3; 
// ã‚ªãƒ¼ãƒˆãƒ—ãƒ¬ã‚¤ãƒ¢ãƒ¼ãƒ‰ã‹ã©ã†ã‹
let isAuto = false;
// ã‚ªãƒ¼ãƒˆãƒ—ãƒ¬ã‚¤ç”¨ã®ã‚¿ã‚¤ãƒãƒ¼ID
let autoTimer = null;
// ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®è‰²ï¼ˆ'w' ã¾ãŸã¯ 'b'ï¼‰
let playerColor = 'w';
// ã‚ªãƒ¼ãƒ‡ã‚£ã‚ªã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆï¼ˆåŠ¹æœéŸ³ç”¨ï¼‰
let audioCtx = null;
// ãƒ‰ãƒ©ãƒƒã‚°ä¸­ã®ãƒã‚¤ãƒ©ã‚¤ãƒˆåˆ¶å¾¡ç”¨
let currentDragHover = null; 

// === ãƒ¡ã‚¹ã‚¬ã‚­ãƒ»ã‚­ãƒ£ãƒ©å®šç¾©ï¼ˆé¡”æ–‡å­—ï¼‰ ===
// è‡ªåˆ†ã®ã‚¿ãƒ¼ãƒ³æ™‚ã®é¡”
const EMOJI_SELF = "ğŸ§™â€â™‚ï¸"; 
// ã‚ªãƒ¼ãƒˆãƒ¢ãƒ¼ãƒ‰æ™‚ã®é¡”
const EMOJI_ROBOT = "ğŸ¤–"; 
// ç‹æ‰‹ã•ã‚ŒãŸæ™‚ã®é¡”
const EMOJI_SCARED = "ğŸ˜±"; 

// æ•µã®é€šå¸¸é¡”ï¼ˆãƒ©ãƒ³ãƒ€ãƒ ï¼‰
const EMOJI_ENEMY_NORMAL = ["ğŸ˜", "ğŸ¥´", "ğŸ˜—"];
// æ•µã®æ€è€ƒä¸­ã®é¡”ï¼ˆãƒ©ãƒ³ãƒ€ãƒ ï¼‰
const EMOJI_ENEMY_THINK = ["ğŸ¤”", "ğŸ¤¨", "ğŸ˜¶"]; 
// æ•µãŒå‹ã£ãŸæ™‚ã®é¡”ï¼ˆãƒ©ãƒ³ãƒ€ãƒ ï¼‰
const EMOJI_ENEMY_WIN = ["ğŸ˜†", "ğŸ¤£", "ğŸ˜ˆ", "ğŸ¤ª"];
// æ•µãŒè² ã‘ãŸæ™‚ã®é¡”ï¼ˆãƒ©ãƒ³ãƒ€ãƒ ï¼‰
const EMOJI_ENEMY_LOSE = ["ğŸ˜­", "ğŸ˜¡", "ğŸ¤¯", "ğŸ¤¢"];
// æ•µãŒç‹æ‰‹ã‚’ã‹ã‘ãŸæ™‚ã®é¡”ï¼ˆãƒ©ãƒ³ãƒ€ãƒ ï¼‰
const EMOJI_ENEMY_CHECK = ["ğŸ¤­", "ğŸ˜", "ğŸ”ª"];

// UIè¦ç´ ã®jQueryã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚­ãƒ£ãƒƒã‚·ãƒ¥
const ui = { 
  face: $('#face'), msg: $('#msg'), status: $('#status'), 
  btnAuto: $('#btn-auto'), btnHint: $('#btn-hint'), btnUndo: $('#btn-undo'), btnRetry: $('#btn-retry'), 
  evalWhite: $('#eval-bar-white'), boardWrap: $('.board-wrap') 
};

// === é§’åè¾æ›¸ï¼ˆè§£èª¬ç”¨æ—¥æœ¬èªï¼‰ ===
const pieceNames = { p: "ãƒãƒ¼ãƒ³", n: "ãƒŠã‚¤ãƒˆ", b: "ãƒ“ã‚·ãƒ§ãƒƒãƒ—", r: "ãƒ«ãƒ¼ã‚¯", q: "ã‚¯ã‚¤ãƒ¼ãƒ³", k: "ã‚­ãƒ³ã‚°" };

// === èªéŒ²ï¼ˆç”Ÿæ„æ°—ï¼†å…·ä½“çš„ï¼‰ ===
// â˜…ã€æ”¹ä¿®ã€‘æˆ¦æ³ã«å¿œã˜ã¦ã‚»ãƒªãƒ•ã‚’å¤‰ãˆã‚‹ãŸã‚ã®è¾æ›¸æ§‹é€ æ‹¡å¼µ
const msgDict = {
  // ã‚²ãƒ¼ãƒ é–‹å§‹æ™‚ã®æŒ¨æ‹¶
  start: ["ã¸ã‡ã€ç§ã«æŒ‘ã‚€ã‚“ã ï¼Ÿ 100å¹´æ—©ã„ã‚“ã˜ã‚ƒãªã„ï¼Ÿ", "é›‘é­šç‹©ã‚Šã®æ™‚é–“ã ã€œâ™¥", "æ‰‹åŠ æ¸›ãªã—ã§ãƒœã‚³ãƒœã‚³ã«ã—ã¦ã‚ã’ã‚‹â™ª"],
    
  // ç„¡åŠ¹ãªå‹•ãã‚’ã—ãŸæ™‚
  invalidMove: ["ã¯ï¼Ÿ ãã“ã¯ãƒ«ãƒ¼ãƒ«é•åã ã£ã¦ã°ï½—", "ãƒ«ãƒ¼ãƒ«ã‚‚çŸ¥ã‚‰ãªã„ã®ï¼Ÿ ã–ãƒ¼ã“â™¥", "ã¡ã‚ƒã‚“ã¨é§’ã®å‹•ãè¦šãˆãªã‚ˆã€œ"],
  // ç‹æ‰‹ã‚’ç„¡è¦–ã—ã¦å‹•ã‹ãã†ã¨ã—ãŸæ™‚
  ignoreCheck: ["ãƒã€œã‚«ï¼ ç‹æ§˜å–ã‚‰ã‚Œã¡ã‚ƒã†ã‚ˆï¼Ÿ", "ç‹æ‰‹ã‹ã‹ã£ã¦ã‚‹ã®ï¼ ç›®ã¤ã„ã¦ã‚‹ï¼Ÿ", "è² ã‘ãŸã„ã®ã‹ãªï¼Ÿï½—"],
    
  // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒé§’ã‚’å–ã£ãŸ
  captureByPlayer: (p) => [`ã‚ãƒ¼ã‚ã€${p}ãŒå–ã‚‰ã‚Œã¡ã‚ƒã£ãŸ...`, `ãµã‚“ã€${p}ãã‚‰ã„ãã‚Œã¦ã‚„ã‚‹ã‚ˆã€‚`, `èª¿å­ã«ä¹—ã‚‰ãªã„ã§ã‚ˆã­ã€ãŸã‹ãŒ${p}ã ã—ï¼`],
    
  // AIãŒé§’ã‚’å–ã£ãŸ
  captureByEnemy: (p) => [`ã„ãŸã ãã€œâ™¥ ã‚ã‚“ãŸã®${p}ã€å¼±ã™ãï½—`, `ä¸ç”¨å¿ƒã ã­ã‡ã€œï½— ${p}ã¯æ²¡åï¼`, `ã‚ã€œã‚ã€${p}æ¸›ã£ã¡ã‚ƒã£ãŸï½— ã–ã¾ã‚ï½—`],
    
  // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒç‹æ‰‹ã‚’ã‹ã‘ãŸ
  checkByPlayer: ["ã†ã£...ç”Ÿæ„æ°—ãªï¼", "ãã¬ã¬...ã¾ã è©°ã¾ãªã„ã—ï¼", "ã¡ã‚‡ã£ã¨ï¼ ã³ã£ãã‚Šã™ã‚‹ã˜ã‚ƒã‚“ï¼"],
    
  // AIãŒç‹æ‰‹ã‚’ã‹ã‘ãŸ
  checkByEnemy: ["ç‹æ‰‹ã€œâ™ª æ°—ã¥ã„ã¦ãŸï¼Ÿï½—", "ã»ã‚‰ã»ã‚‰ã€é€ƒã’ãªã„ã¨çµ‚ã‚ã£ã¡ã‚ƒã†ã‚ˆï¼Ÿ", "æ¬¡ã§çµ‚ã‚ã‚Šã‹ã‚‚ã­ã€œâ™¥"],
    
  // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®æ™®é€šã®æ‰‹ï¼ˆé€šå¸¸æ™‚ï¼‰
  moveByPlayer_Even: ["ãµãƒ¼ã‚“ã€ãã†å‹•ãã‚“ã ã€‚", "ã¸ã‡...æ‚ªããªã„ã‹ã‚‚ï¼Ÿ", "ã‚‚ã£ã¨ã„ã„æ‰‹ã‚ã£ãŸã‚“ã˜ã‚ƒãªã„ï¼Ÿï½—", "å¿…æ­»ã ã­ã‡ã€œï½—"],
  // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®æ™®é€šã®æ‰‹ï¼ˆAIå„ªå‹¢æ™‚ï¼ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼åŠ£å‹¢ï¼‰
  moveByPlayer_AiWinning: ["ç„¡é§„ãªæŠµæŠ—ã”è‹¦åŠ´ã•ã¾ã€œï½—", "ã­ãˆã€ã¾ã ç¶šã‘ã‚‹ã®ï¼Ÿ æ—©ãé™å‚ã—ãªã‚ˆï½—", "ãã®æ‰‹ã€ä½•ã®æ„å‘³ãŒã‚ã‚‹ã®ï¼Ÿ", "ã‚ãŒã‘ã°ã‚ãŒãã»ã©æƒ¨ã‚ã ã­ã‡ï½—"],
  // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®æ™®é€šã®æ‰‹ï¼ˆAIåŠ£å‹¢æ™‚ï¼ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼å„ªå‹¢ï¼‰
  moveByPlayer_AiLosing: ["ãã¬ã¬â€¦èª¿å­ä¹—ã‚‹ãªã‚ˆï¼Ÿ", "ã¾ã€ã¾ãã‚Œã§ã—ã‚‡ã€ã¾ãã‚Œï¼", "ã†ã–â€¦ãªã‚“ã§ãã‚“ãªæ‰‹ãŒè¦‹ãˆã‚‹ã‚ã‘ï¼Ÿ", "ãã£â€¦ã¾ã è² ã‘ã¦ãªã„ã—ï¼"],
    
  // AIã®æ™®é€šã®æ‰‹ï¼ˆé€šå¸¸æ™‚ï¼‰
  moveByEnemy_Even: ["ã“ã‚Œãªã‚‰ã©ã†ï¼Ÿ", "ç§ã®ã‚¿ãƒ¼ãƒ³ï¼", "ã“ã‚Œã§ã‚¤ãƒã‚³ãƒ­ã ã‚ˆâ™ª", "è¨ˆç®—é€šã‚Šã ã—ã€œ"],
  // AIã®æ™®é€šã®æ‰‹ï¼ˆAIå„ªå‹¢æ™‚ï¼‰
  moveByEnemy_AiWinning: ["ã¯ã„ã€ã“ã‚Œã§è©°ã¿ã˜ã‚ƒãªã„ï¼Ÿï½—", "ã‚‚ã†çµ‚ã‚ã‚ŠãŒè¦‹ãˆã¦ããŸã­ã€œ", "çµ¶æœ›ã—ãªã•ã„â™ª", "å¼±ã„å¼±ã„ã€å¼±ã™ãã‚‹ã‚ˆã€œï½—"],
  // AIã®æ™®é€šã®æ‰‹ï¼ˆAIåŠ£å‹¢æ™‚ï¼‰
  moveByEnemy_AiLosing: ["ã¾ã â€¦ã¾ã é€†è»¢ã§ãã‚‹ã—â€¦ï¼", "æœ¬æ°—å‡ºã™ã‹ã‚‰è¦šæ‚Ÿã—ãªã•ã„ã‚ˆï¼", "ã†ã…â€¦ãªã‚“ã§ã“ã†ãªã‚‹ã®â€¦", "è«¦ã‚ãªã„ã‚‚ã‚“ï¼"],

  // æ±ºç€æ™‚
  win: ["ã¯ã„ç§ã®å‹ã¡ã€œï¼ å¼±ã™ãï½—", "ã–ã€œã“â™¥ ã–ã€œã“â™¥", "å‡ºç›´ã—ã¦ããªã•ã„ï¼"],
  lose: ["ã†ã...è² ã‘ãŸ...ï¼Ÿ", "ãã¬ã¬...æ¬¡ã¯çµ¶å¯¾å‹ã¤ã‹ã‚‰ï¼", "è¦šãˆã¨ããªã•ã„ã‚ˆï¼"],
  draw: ["ã¡ã£ã€å¼•ãåˆ†ã‘ã‹...", "é€ƒã’åˆ‡ã£ãŸã¤ã‚‚ã‚Šï¼Ÿ", "ã¤ã¾ã‚“ãªã„ã®ãƒ¼"],
    
  // ã‚ªãƒ¼ãƒˆæ©Ÿèƒ½é–¢é€£
  autoOn: ["ã¯ï¼Ÿ ãƒ­ãƒœãƒƒãƒˆã«é ¼ã‚‹ã®ï¼Ÿ ãƒ€ãƒƒã‚µï½—", "è‡ªåˆ†ã§å‹ã¦ãªã„ã‹ã‚‰ã£ã¦æ©Ÿæ¢°é ¼ã‚Šï¼Ÿ", "ãƒ—ãƒ©ã‚¤ãƒ‰ãªã„ã®ã€œï¼Ÿ ã–ãƒ¼ã“ï½—"],
  autoResumeMe: ["ã‚ã‚Œï¼Ÿ ãƒ­ãƒœãƒƒãƒˆãã‚“ã‚¯ãƒ“ï¼Ÿï½—", "ã»ã‚‰ã€è‡ªåˆ†ã®ç•ªã ã‚ˆï¼Ÿ é€ƒã’ãªã„ã§ã‚ˆã­ï¼", "ã‚„ã£ã¨è‡ªåˆ†ã§ã‚„ã‚‹æ°—ã«ãªã£ãŸï¼Ÿ"],
  autoResumeEnemy: ["ç›¸æ‰‹ï¼ˆç§ï¼‰ãŒè€ƒãˆã¦ã‚‹é€”ä¸­ã ã‹ã‚‰ã¡ã‚‡ã£ã¨å¾…ã£ã¦ãªã•ã„ã‚ˆã€‚", "ãƒ­ãƒœãƒƒãƒˆãã‚“å¾…æ©Ÿä¸­ã€œã€‚", "ã‚ã€é€ƒã’ãŸï½—"],
    
  // ãã®ä»–
  hint: ["ã»ã‚‰ã€ã“ã“å‹•ã‹ã›ã°ï¼Ÿ ç‰¹åˆ¥ã‚µãƒ¼ãƒ“ã‚¹ã ã‹ã‚‰ã­ï¼", "ã—ã‚‡ã†ãŒãªã„ãªã...ä»Šå›ã ã‘ã ã‚ˆï¼Ÿ", "ã“ã‚“ãªæ‰‹ã‚‚è¦‹ãˆãªã„ã®ï¼Ÿ è¦–é‡ç‹­ã™ãï½—"],
  undo: ["å¾…ã£ãŸï¼Ÿ å¾€ç”Ÿéš›ãŒæ‚ªã„ãªã...", "ãˆãƒ¼ã€ãšã‚‹ããªã„ï¼Ÿ ã¾ã€ã„ã„ã‘ã©ï½—", "ã¯ã„ã¯ã„ã€è¦‹ãªã‹ã£ãŸã“ã¨ã«ã—ã¦ã‚ã’ã‚‹ã€‚"]
};

// é…åˆ—ã‹ã‚‰ãƒ©ãƒ³ãƒ€ãƒ ã«è¦ç´ ã‚’å–å¾—ã™ã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
function getRandom(arr) { return arr[Math.floor(Math.random() * arr.length)]; }
// ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¾æ›¸ã‹ã‚‰ãƒ©ãƒ³ãƒ€ãƒ ã«å–å¾—ï¼ˆé–¢æ•°ãªã‚‰å®Ÿè¡Œçµæœã‚’å–å¾—ï¼‰
function getRandomMsg(cat, param) { 
    const entry = msgDict[cat];
    // é–¢æ•°å‹ï¼ˆé§’åãªã©å¼•æ•°ãŒã‚ã‚‹å ´åˆï¼‰ã®å‡¦ç†
    if (typeof entry === 'function') return getRandom(entry(param));
    // é€šå¸¸ã®é…åˆ—ã¾ãŸã¯æœªå®šç¾©ã®å ´åˆã®å‡¦ç†
    return getRandom(entry || ["..."]); 
}

// === éŸ³éŸ¿ã‚·ã‚¹ãƒ†ãƒ  ===
// ã‚ªãƒ¼ãƒ‡ã‚£ã‚ªã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã®åˆæœŸåŒ–ï¼ˆãƒ–ãƒ©ã‚¦ã‚¶ã®åˆ¶é™å›é¿ã®ãŸã‚ãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œå¾Œã«å‘¼ã¶ï¼‰
function initAudio() { if(!audioCtx) audioCtx = new (window.AudioContext||window.webkitAudioContext)(); if(audioCtx.state==='suspended') audioCtx.resume(); }
// åŠ¹æœéŸ³å†ç”Ÿé–¢æ•°
function playSound(type) {
  if(!audioCtx) return;
  const t = audioCtx.currentTime;
  const osc = audioCtx.createOscillator();
  const gain = audioCtx.createGain();
  osc.connect(gain);
  gain.connect(audioCtx.destination);
  
  if (type === 'move') { // é§’ã‚’å‹•ã‹ã™éŸ³ï¼ˆã‚³ãƒ„ãƒƒï¼‰
    osc.frequency.setValueAtTime(180, t); osc.frequency.exponentialRampToValueAtTime(40, t+0.12);
    gain.gain.setValueAtTime(0.4, t); gain.gain.exponentialRampToValueAtTime(0.01, t+0.12);
    osc.start(t); osc.stop(t+0.12);
  } else if (type === 'capture') { // é§’ã‚’å–ã‚‹éŸ³ï¼ˆã‚«ã‚­ãƒ³ãƒƒï¼‰
    osc.type = 'triangle'; osc.frequency.setValueAtTime(350, t); osc.frequency.exponentialRampToValueAtTime(60, t+0.15);
    gain.gain.setValueAtTime(0.4, t); gain.gain.exponentialRampToValueAtTime(0.01, t+0.15);
    osc.start(t); osc.stop(t+0.15);
  } else if (type === 'start') { // é–‹å§‹éŸ³ï¼ˆãƒ”ãƒ­ãƒªãƒ³ï¼‰
    osc.frequency.setValueAtTime(440, t); osc.frequency.linearRampToValueAtTime(880, t+0.3);
    gain.gain.setValueAtTime(0.1, t); gain.gain.linearRampToValueAtTime(0, t+0.5);
    osc.start(t); osc.stop(t+0.5);
  }
}

// === AIé–¢é€£ (Minimaxæ³• & è©•ä¾¡é–¢æ•°) ===
// é§’ã®ä½ç½®ã«ã‚ˆã‚‹è©•ä¾¡ãƒ†ãƒ¼ãƒ–ãƒ« (Piece-Square Tables)
// é…åˆ—ã¯ç›¤é¢ã®64ãƒã‚¹ã«å¯¾å¿œã—ã€ãã®ä½ç½®ã«ã‚ã‚‹æ™‚ã®ä¾¡å€¤ã‚’ç¤ºã™
const PST={
    // ãƒãƒ¼ãƒ³ï¼šå‰é€²ã™ã‚‹ã»ã©ä¾¡å€¤ãŒé«˜ã„
    p:[0,0,0,0,0,0,0,0,50,50,50,50,50,50,50,50,10,10,20,30,30,20,10,10,5,5,10,25,25,10,5,5,0,0,0,20,20,0,0,0,5,-5,-10,0,0,-10,-5,5,5,10,10,-20,-20,10,10,5,0,0,0,0,0,0,0,0],
    // ãƒŠã‚¤ãƒˆï¼šä¸­å¤®ã«ã„ã‚‹ã»ã©ä¾¡å€¤ãŒé«˜ã„
    n:[-50,-40,-30,-30,-30,-30,-40,-50,-40,-20,0,0,0,0,-20,-40,-30,0,10,15,15,10,0,-30,-30,5,15,20,20,15,5,-30,-30,0,15,20,20,15,0,-30,-30,5,10,15,15,10,5,-30,-40,-20,0,5,5,0,-20,-40,-50,-40,-30,-30,-30,-30,-40,-50],
    // ãƒ“ã‚·ãƒ§ãƒƒãƒ—ï¼šé•·ã„å¯¾è§’ç·šã‚’ç‹™ãˆã‚‹ä½ç½®ãŒè‰¯ã„
    b:[-20,-10,-10,-10,-10,-10,-10,-20,-10,0,0,0,0,0,0,-10,-10,0,5,10,10,5,0,-10,-10,5,5,10,10,5,5,-10,-10,0,10,10,10,10,0,-10,-10,10,10,10,10,10,10,-10,-10,5,0,0,0,0,5,-10,-20,-10,-10,-10,-10,-10,-10,-20],
    // ãƒ«ãƒ¼ã‚¯ï¼šã‚ªãƒ¼ãƒ—ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ã‚„7æ®µç›®ãŒå¼·ã„
    r:[0,0,0,0,0,0,0,0,5,10,10,10,10,10,10,5,-5,0,0,0,0,0,0,-5,-5,0,0,0,0,0,0,-5,-5,0,0,0,0,0,0,-5,-5,0,0,0,0,0,0,-5,-5,0,0,0,0,0,0,-5,0,0,0,5,5,0,0,0],
    // ã‚¯ã‚¤ãƒ¼ãƒ³ï¼šå‹•ãã‚„ã™ã„ä¸­å¤®ãŒè‰¯ã„
    q:[-20,-10,-10,-5,-5,-10,-10,-20,-10,0,0,0,0,0,0,-10,-10,0,5,5,5,5,0,-10,-5,0,5,5,5,5,0,-5,0,0,5,5,5,5,0,-5,-10,5,5,5,5,5,0,-10,-10,0,5,0,0,0,0,-10,-20,-10,-10,-5,-5,-10,-10,-20],
    // ã‚­ãƒ³ã‚°ï¼šåºç›¤ãƒ»ä¸­ç›¤ã¯å®ˆã‚ŠãŒå …ã„å ´æ‰€ãŒè‰¯ã„
    k:[-30,-40,-40,-50,-50,-40,-40,-30,-30,-40,-40,-50,-50,-40,-40,-30,-30,-40,-40,-50,-50,-40,-40,-30,-30,-40,-40,-50,-50,-40,-40,-30,-20,-30,-30,-40,-40,-30,-30,-20,-10,-20,-20,-20,-20,-20,-20,-10,20,20,0,0,0,0,20,20,20,30,10,0,0,10,30,20]
};
// é§’è‡ªä½“ã®åŸºæœ¬çš„ä¾¡å€¤
const VAL={p:100,n:320,b:330,r:500,q:900,k:20000};

// ç›¤é¢å…¨ä½“ã®è©•ä¾¡å€¤ã‚’è¨ˆç®—ã™ã‚‹é–¢æ•°ï¼ˆæ­£ãªã‚‰ç™½æœ‰åˆ©ã€è² ãªã‚‰é»’æœ‰åˆ©ï¼‰
function getBoardValue(g) {
  let v = 0; const b = g.board();
  for(let r=0; r<8; r++) for(let c=0; c<8; c++) {
    const p = b[r][c];
    if(p) {
      // é§’ã®ä¾¡å€¤ + ä½ç½®ã®ä¾¡å€¤ ã‚’è¨ˆç®—
      // é»’ç•ªã®å ´åˆã¯é…åˆ—ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’åè»¢ã•ã›ã‚‹
      let score = VAL[p.type] + (PST[p.type][p.color==='w'?(r*8+c):((7-r)*8+c)]||0);
      // ç™½ãªã‚‰ãƒ—ãƒ©ã‚¹ã€é»’ãªã‚‰ãƒã‚¤ãƒŠã‚¹ã§åŠ ç®—
      v += (p.color==='w' ? score : -score);
    }
  }
  return v;
}

// æ¢ç´¢åŠ¹ç‡ã‚’ä¸Šã’ã‚‹ãŸã‚ã®æ‰‹ç•ªä¸¦ã¹æ›¿ãˆï¼ˆMove Orderingï¼‰
// å¼·ã„æ‰‹ï¼ˆé§’ã‚’å–ã‚‹æ‰‹ãªã©ï¼‰ã‚’å…ˆã«æ¢ç´¢ã•ã›ã‚‹
function orderMoves(moves) {
  return moves.sort((a,b)=>{
    let sA=0,sB=0;
    // é§’ã‚’å–ã‚‹æ‰‹ã¯é«˜è©•ä¾¡
    if(a.flags.includes('c')) sA+=10+(VAL[a.captured]||0)-(VAL[a.piece]||0)/10;
    // ãƒ—ãƒ­ãƒ¢ãƒ¼ã‚·ãƒ§ãƒ³ã‚‚é«˜è©•ä¾¡
    if(a.flags.includes('p')) sA+=100;
    if(b.flags.includes('c')) sB+=10+(VAL[b.captured]||0)-(VAL[b.piece]||0)/10;
    if(b.flags.includes('p')) sB+=100;
    // é™é †ã‚½ãƒ¼ãƒˆ
    return sB-sA;
  });
}

// ãƒŸãƒ‹ãƒãƒƒã‚¯ã‚¹æ³•ï¼ˆã‚¢ãƒ«ãƒ•ã‚¡ãƒ™ãƒ¼ã‚¿æ³•ã«ã‚ˆã‚‹æåˆˆã‚Šä»˜ãï¼‰ã«ã‚ˆã‚‹æ¢ç´¢
function minimax(g, depth, alpha, beta, isMax) {
  // æ·±ã•0ã¾ãŸã¯ã‚²ãƒ¼ãƒ çµ‚äº†ãªã‚‰è©•ä¾¡å€¤ã‚’è¿”ã™
  if (depth===0 || g.game_over()) return getBoardValue(g);
  
  // å¯èƒ½ãªæ‰‹ã‚’ç”Ÿæˆã—ã¦ä¸¦ã¹æ›¿ãˆ
  let moves = orderMoves(g.moves({ verbose: true }));
  if(moves.length === 0) return getBoardValue(g);
  
  // æœ€å¤§åŒ–ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ï¼ˆç™½ï¼‰ã®å ´åˆ
  if (isMax) {
    let maxEval = -Infinity;
    for (let m of moves) {
      g.move(m); 
      // å†å¸°å‘¼ã³å‡ºã—
      let eval = minimax(g, depth-1, alpha, beta, false); 
      g.undo();
      maxEval = Math.max(maxEval, eval); 
      alpha = Math.max(alpha, eval);
      // ãƒ™ãƒ¼ã‚¿ã‚«ãƒƒãƒˆ
      if (beta <= alpha) break;
    }
    return maxEval;
  } 
  // æœ€å°åŒ–ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ï¼ˆé»’ï¼‰ã®å ´åˆ
  else {
    let minEval = Infinity;
    for (let m of moves) {
      g.move(m); 
      // å†å¸°å‘¼ã³å‡ºã—
      let eval = minimax(g, depth-1, alpha, beta, true); 
      g.undo();
      minEval = Math.min(minEval, eval); 
      beta = Math.min(beta, eval);
      // ã‚¢ãƒ«ãƒ•ã‚¡ã‚«ãƒƒãƒˆ
      if (beta <= alpha) break;
    }
    return minEval;
  }
}

// æœ€å–„æ‰‹ã‚’æ±ºå®šã™ã‚‹é–¢æ•°
function getBestMove(levelOverride) {
  const currentLevel = levelOverride || aiLevel;
  // åˆæ³•æ‰‹ã‚’å–å¾—
  const moves = game.moves({ verbose: true });
  if (!moves.length) return null;
  
  // ãƒ¬ãƒ™ãƒ«1ï¼ˆé›‘é­šï¼‰ï¼š50%ã®ç¢ºç‡ã§å®Œå…¨ãƒ©ãƒ³ãƒ€ãƒ ã€ãã†ã§ãªã‘ã‚Œã°é§’ã‚’å–ã‚‹æ‰‹å„ªå…ˆ
  if (currentLevel === 1) {
    if(Math.random()<0.5) return getRandom(moves);
    const captures = moves.filter(m => m.flags.includes('c'));
    return captures.length ? getRandom(captures) : getRandom(moves);
  }
  
  // ãƒ¬ãƒ™ãƒ«2ã¯2æ‰‹å…ˆã€ãƒ¬ãƒ™ãƒ«3ã¯3æ‰‹å…ˆã‚’èª­ã‚€
  const depth = (currentLevel === 2) ? 2 : 3;
  const isWhite = (game.turn() === 'w');
  
  let bestMove = null; 
  let bestVal = isWhite ? -Infinity : Infinity;
  
  const orderedMoves = orderMoves(moves);
  
  // ã™ã¹ã¦ã®æ‰‹ã«ã¤ã„ã¦è©•ä¾¡å€¤ã‚’è¨ˆç®—
  for(let m of orderedMoves) {
    game.move(m);
    // ç›¸æ‰‹ã®ç•ªã«ãªã‚‹ã®ã§ isMax ã‚’åè»¢ã—ã¦å‘¼ã¶
    let val = minimax(game, depth - 1, -Infinity, Infinity, !isWhite);
    game.undo();
    
    // æœ€è‰¯ã®æ‰‹ã‚’æ›´æ–°
    if(isWhite) { if(val > bestVal) { bestVal = val; bestMove = m; } }
    else { if(val < bestVal) { bestVal = val; bestMove = m; } }
  }
  // æœ€å–„æ‰‹ãŒè¦‹ã¤ã‹ã‚‰ãªã‘ã‚Œã°ãƒ©ãƒ³ãƒ€ãƒ 
  return bestMove || getRandom(moves);
}

// === ã‚²ãƒ¼ãƒ é€²è¡Œãƒ­ã‚¸ãƒƒã‚¯ ===
// ã‚²ãƒ¼ãƒ é–‹å§‹å‡¦ç†
function startGame() {
  initAudio(); playSound('start');
  
  // è¨­å®šå€¤ã®å–å¾—
  playerColor = $('#color-select').val();
  aiLevel = parseInt($('#level').val());
  
  // ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’éš ã™
  $('#menu').addClass('hidden');
  
  // ã‚²ãƒ¼ãƒ ãƒªã‚»ãƒƒãƒˆ
  game.reset(); 
  isAuto = false; 
  clearTimeout(autoTimer);
  $('#board').empty();
  
  // ç›¤é¢ã®å‘ãè¨­å®š
  const orient = playerColor==='w'?'white':'black';
  
  // é§’ã®ç”»åƒã‚’SVGã§ç”Ÿæˆã™ã‚‹é–¢æ•°
  const pieceTheme = p => {
    const c = p[0]==='w'?'#fff':'#000', s = p[0]==='w'?'#000':'#fff';
    const sym = {'P':'â™™','N':'â™˜','B':'â™—','R':'â™–','Q':'â™•','K':'â™”','p':'â™Ÿ','n':'â™','b':'â™','r':'â™œ','q':'â™›','k':'â™š'};
    // SVGæ–‡å­—åˆ—ã‚’ä½œæˆã—ã¦DataURIã¨ã—ã¦è¿”ã™
    return 'data:image/svg+xml;charset=utf-8,' + encodeURIComponent(`<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 60 60"><text x="50%" y="58%" text-anchor="middle" dominant-baseline="middle" font-family="sans-serif" font-size="50" fill="${c}" stroke="${s}" stroke-width="1.5">${sym[p[1]]||'?'}</text></svg>`);
  };

  // ãƒã‚§ã‚¹ãƒœãƒ¼ãƒ‰UIã®ç”Ÿæˆ
  board = Chessboard('board', {
    draggable: true, 
    position: 'start', 
    orientation: orient, 
    pieceTheme: pieceTheme,
    // ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©ç™»éŒ²
    onDragStart: onDragStart, 
    onDragMove: onDragMove, 
    onDrop: onDrop, 
    onSnapEnd: onSnapEnd
  });
  
  // ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ãƒªã‚µã‚¤ã‚ºæ™‚ã«ãƒœãƒ¼ãƒ‰ã‚µã‚¤ã‚ºã‚’èª¿æ•´
  $(window).resize(board.resize);
  
  // åˆæœŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¨­å®š
  ui.msg.text(getRandomMsg('start'));
  ui.btnAuto.removeClass('btn-auto-active').text("ğŸ¤– ã‚ªãƒ¼ãƒˆ: OFF");
  
  updateStatus();
  gameLoop();
}

// ãƒ¡ã‚¤ãƒ³ãƒ«ãƒ¼ãƒ—ï¼ˆã‚¿ãƒ¼ãƒ³ã®ç®¡ç†ï¼‰
function gameLoop() {
  clearTimeout(autoTimer);
  if(game.game_over()) return;

  const myTurn = (game.turn() === playerColor);
  
  // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ã‚¿ãƒ¼ãƒ³ã§ã‚ªãƒ¼ãƒˆã§ãªã„ãªã‚‰å¾…æ©Ÿ
  if (myTurn && !isAuto) {
    return;
  }
  
  // AIã®ã‚¿ãƒ¼ãƒ³ã¾ãŸã¯ã‚ªãƒ¼ãƒˆãƒ¢ãƒ¼ãƒ‰ãªã‚‰å°‘ã—å¾…ã£ã¦ã‹ã‚‰å‹•ã‹ã™
  autoTimer = setTimeout(() => {
    makeAiMove();
  }, 600);
}

// AIã«ã‚ˆã‚‹æŒ‡ã—æ‰‹å®Ÿè¡Œ
function makeAiMove() {
  if (game.game_over()) return;

  const turnColor = game.turn();
  const isEnemy = (turnColor !== playerColor);
  // æ•µAIãªã‚‰è¨­å®šãƒ¬ãƒ™ãƒ«ã€ã‚ªãƒ¼ãƒˆä¸­ã®è‡ªåˆ†ãªã‚‰æœ€å¼·ãƒ¬ãƒ™ãƒ«ã‚’ä½¿ç”¨
  const useLevel = isEnemy ? aiLevel : 3;
  
  const m = getBestMove(useLevel);
  if (m) {
    const moveResult = game.move(m);
    board.position(game.fen());
    playSound(moveResult.flags.includes('c') ? 'capture' : 'move');
    
    // AIã®æ‰‹ã«å¯¾ã™ã‚‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æ›´æ–°ï¼ˆç¬¬2å¼•æ•°false = AIã®æ‰‹ï¼‰
    updateTurnMessage(moveResult, false); 
    updateStatus();
    
    // æ¬¡ã®ã‚¿ãƒ¼ãƒ³ã¸
    gameLoop(); 
  }
}

// === ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼æ“ä½œã‚¤ãƒ™ãƒ³ãƒˆ ===
// ãƒ‰ãƒ©ãƒƒã‚°é–‹å§‹æ™‚ã®å‡¦ç†
function onDragStart(source, piece) {
  // ã‚²ãƒ¼ãƒ çµ‚äº†æ™‚ã‚„ã‚ªãƒ¼ãƒˆæ™‚ã¯æ“ä½œä¸å¯
  if (game.game_over() || isAuto) return false;
  // è‡ªåˆ†ã®ã‚¿ãƒ¼ãƒ³ã§ãªã„ãªã‚‰æ“ä½œä¸å¯
  if (game.turn() !== playerColor) return false;
  // è‡ªåˆ†ã®é§’ã§ãªã„ãªã‚‰æ“ä½œä¸å¯
  if ((playerColor === 'w' && piece.search(/^b/) !== -1) || (playerColor === 'b' && piece.search(/^w/) !== -1)) return false;
  
  // ç§»å‹•å¯èƒ½ãªãƒã‚¹ã‚’å–å¾—
  const moves = game.moves({ square: source, verbose: true });
  if (moves.length === 0) return false;

  // ä»¥å‰ã®ãƒã‚¤ãƒ©ã‚¤ãƒˆã‚’æ¶ˆã™
  removeHighlights();
  // ç§»å‹•å¯èƒ½ãƒã‚¹ã‚’ãƒã‚¤ãƒ©ã‚¤ãƒˆï¼ˆé€šå¸¸ç§»å‹•ã¨ã‚­ãƒ£ãƒ—ãƒãƒ£ã§è‰²åˆ†ã‘ï¼‰
  moves.forEach(m => {
    $('#board .square-' + m.to).addClass(m.flags.includes('c') ? 'highlight-capture' : 'highlight-move');
  });
}

// ãƒ‰ãƒ©ãƒƒã‚°ä¸­ã®å‡¦ç†ï¼ˆå±é™ºå¯ŸçŸ¥æ¼”å‡ºãªã©ï¼‰
function onDragMove(newLocation, oldLocation, source, piece) {
  if (newLocation === currentDragHover) return; 
  currentDragHover = newLocation;
  // å±é™ºè¡¨ç¤ºã‚’ãƒªã‚»ãƒƒãƒˆ
  $('#board .square-55d63').removeClass('highlight-danger-source');
  if (newLocation === 'offboard') return;

  // ä¸€æ™‚çš„ã«å‹•ã‹ã—ã¦ã¿ã¦ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
  const tempGame = new Chess(game.fen());
  const move = tempGame.move({ from: source, to: newLocation, promotion: 'q' });
  if (move) {
      // ç›¸æ‰‹ã®è¿”ã—ã®æ‰‹ã‚’å…¨æ¤œç´¢
      const enemyMoves = tempGame.moves({ verbose: true });
      // ãã®ãƒã‚¹ã¸æ”»æ’ƒã—ã¦ãã‚‹æ‰‹ã‚’æ¢ã™
      const attackers = enemyMoves.filter(m => m.to === newLocation);
      if (attackers.length > 0) {
        // æ”»æ’ƒå…ƒã®é§’ã‚’ã‚ªãƒ¬ãƒ³ã‚¸è‰²ã«å…‰ã‚‰ã›ã¦è­¦å‘Š
        attackers.forEach(m => $('#board .square-' + m.from).addClass('highlight-danger-source'));
      }
  }
}

// ãƒ‰ãƒ­ãƒƒãƒ—æ™‚ï¼ˆæŒ‡ã—æ‰‹ç¢ºå®šï¼‰ã®å‡¦ç†
function onDrop(source, target) {
  removeHighlights();
  $('#board .square-55d63').removeClass('highlight-danger-source');
  
  const wasInCheck = game.in_check();
  // å‹•ãã‚’é©ç”¨ã—ã¦ã¿ã‚‹ï¼ˆãƒ—ãƒ­ãƒ¢ãƒ¼ã‚·ãƒ§ãƒ³ã¯ã‚¯ã‚¤ãƒ¼ãƒ³å›ºå®šï¼‰
  const move = game.move({ from: source, to: target, promotion: 'q' });

  // ç„¡åŠ¹ãªæ‰‹ã®å ´åˆ
  if (move === null) {
    if (wasInCheck) ui.msg.text(getRandomMsg('ignoreCheck')); // ç‹æ‰‹æ”¾ç½®ã¸ã®ãƒ„ãƒƒã‚³ãƒŸ
    else ui.msg.text(getRandomMsg('invalidMove')); // ãƒ«ãƒ¼ãƒ«é•åã¸ã®ãƒ„ãƒƒã‚³ãƒŸ
    return 'snapback'; // é§’ã‚’æˆ»ã™
  }

  // éŸ³ã‚’é³´ã‚‰ã™
  playSound(move.flags.includes('c') ? 'capture' : 'move');
  
  // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®æ‰‹ã«å¯¾ã™ã‚‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æ›´æ–°ï¼ˆç¬¬2å¼•æ•°true = ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®æ‰‹ï¼‰
  updateTurnMessage(move, true);
  updateStatus();
  
  gameLoop();
}

// ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³çµ‚äº†å¾Œã®ä½ç½®èª¿æ•´
function onSnapEnd() { board.position(game.fen()); }

// â˜…ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æ›´æ–°ï¼ˆå…·ä½“çš„ï¼†ç”Ÿæ„æ°—ï¼†æˆ¦æ³å¯¾å¿œï¼‰
function updateTurnMessage(move, isPlayerMove) {
    if (game.game_over()) return; 

    // ãƒã‚§ãƒƒã‚¯çŠ¶æ…‹ï¼ˆæœ€å„ªå…ˆï¼‰
    if (game.in_check()) {
        ui.msg.text(isPlayerMove ? getRandomMsg('checkByPlayer') : getRandomMsg('checkByEnemy'));
        return;
    }

    // é§’ã‚’å–ã£ãŸï¼ˆå„ªå…ˆåº¦é«˜ï¼‰
    if (move.flags.includes('c')) {
        const pieceName = pieceNames[move.captured] || "é§’";
        ui.msg.text(isPlayerMove ? getRandomMsg('captureByPlayer', pieceName) : getRandomMsg('captureByEnemy', pieceName));
        return;
    }

    // â˜…ã€æ”¹ä¿®ã€‘é€šå¸¸ã®ç§»å‹•ï¼šæˆ¦æ³åˆ¤æ–­ãƒ­ã‚¸ãƒƒã‚¯ã‚’è¿½åŠ 
    // ç¾åœ¨ã®ã‚¹ã‚³ã‚¢ã‚’å–å¾—ï¼ˆç™½ãŒãƒ—ãƒ©ã‚¹ï¼‰
    const rawScore = getBoardValue(game);
    // AIè¦–ç‚¹ã§ã®ã‚¢ãƒ‰ãƒãƒ³ãƒ†ãƒ¼ã‚¸ã‚’è¨ˆç®—
    // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒç™½('w')ãªã‚‰ã€AIã¯é»’ãªã®ã§ã‚¹ã‚³ã‚¢ã‚’åè»¢ã•ã›ã‚‹
    // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒé»’('b')ãªã‚‰ã€AIã¯ç™½ãªã®ã§ã‚¹ã‚³ã‚¢ãã®ã¾ã¾
    const aiAdvantage = (playerColor === 'w') ? -rawScore : rawScore;
    
    // é–¾å€¤ã‚’è¨­å®šï¼ˆ300ç‚¹ï¼ãƒãƒ¼ãƒ³3å€‹åˆ†ç›¸å½“ã§å„ªåŠ£åˆ¤å®šï¼‰
    let situationSuffix = "_Even"; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯äº’è§’
    if (aiAdvantage > 300) situationSuffix = "_AiWinning"; // AIå„ªå‹¢
    else if (aiAdvantage < -300) situationSuffix = "_AiLosing"; // AIåŠ£å‹¢

    // è¾æ›¸ã®ã‚­ãƒ¼ã‚’ç”Ÿæˆï¼ˆä¾‹: moveByPlayer_AiWinningï¼‰
    const msgKey = (isPlayerMove ? "moveByPlayer" : "moveByEnemy") + situationSuffix;
    
    // ç”Ÿæˆã—ãŸã‚­ãƒ¼ã§ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
    ui.msg.text(getRandomMsg(msgKey));
}

// === UIæ›´æ–° ===
function updateStatus() {
  // è©•ä¾¡å€¤ã‚’è¨ˆç®—
  const score = getBoardValue(game);
  // ã‚·ã‚°ãƒ¢ã‚¤ãƒ‰é–¢æ•°ã‚’ä½¿ã£ã¦0ï½100%ã«æ­£è¦åŒ–ã—ã€ã‚²ãƒ¼ã‚¸ã®å¹…ã«åæ˜ 
  const pct = (1 / (1 + Math.exp(-score / 500))) * 100;
  ui.evalWhite.css('width', pct + '%');
  
  // ã‚¿ãƒ¼ãƒ³è¡¨ç¤ºã®æ›´æ–°
  const isMyTurn = (game.turn() === playerColor);
  if (isMyTurn) ui.face.addClass('active-turn');
  else ui.face.removeClass('active-turn');
  
  ui.status.text(isMyTurn ? "ã‚ãªãŸã®ç•ª" : "ç›¸æ‰‹ã®ç•ª");
  
  // ãƒ‰ãƒ©ãƒƒã‚°æ“ä½œã®æœ‰åŠ¹/ç„¡åŠ¹åˆ‡ã‚Šæ›¿ãˆ
  if(board) board.draggable = (isMyTurn && !isAuto && !game.game_over());

  // ã‚²ãƒ¼ãƒ çµ‚äº†æ™‚ã®å‡¦ç†
  if(game.game_over()) {
    ui.btnRetry.removeClass('hidden'); ui.btnAuto.hide(); ui.btnHint.hide(); ui.btnUndo.hide(); ui.status.text("æ±ºç€ï¼");
    if(game.in_checkmate()) {
        // å‹æ•—åˆ¤å®š
        const iWon = (game.turn()==='b' && playerColor==='w') || (game.turn()==='w' && playerColor==='b');
        // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¨é¡”ã‚¢ã‚¤ã‚³ãƒ³ã®æ›´æ–°
        ui.msg.html(iWon ? getRandomMsg('win') : getRandomMsg('lose'));
        ui.face.text(iWon ? getRandom(EMOJI_ENEMY_LOSE) : getRandom(EMOJI_ENEMY_WIN));
    } else {
        // å¼•ãåˆ†ã‘
        ui.msg.text(getRandomMsg('draw'));
        ui.face.text(getRandom(EMOJI_ENEMY_NORMAL));
    }
    return;
  }
  
  // ãƒã‚§ãƒƒã‚¯æ™‚ã®è¡¨æƒ…å¤‰åŒ–
  if(game.in_check()) {
    if(isMyTurn) { // è‡ªåˆ†ãŒãƒ”ãƒ³ãƒ
       ui.face.text(EMOJI_SCARED);
       ui.boardWrap.addClass('in-check-danger');
    } else { // ç›¸æ‰‹ã‚’è¿½ã„è©°ã‚ãŸ
       ui.face.text(getRandom(EMOJI_ENEMY_CHECK));
       ui.boardWrap.addClass('in-check-danger');
    }
  } 
  else {
    // é€šå¸¸æ™‚ã®è¡¨æƒ…
    ui.boardWrap.removeClass('in-check-danger');
    if(isMyTurn) {
       ui.face.text(isAuto ? EMOJI_ROBOT : EMOJI_SELF);
    } else {
       ui.face.text(getRandom(EMOJI_ENEMY_THINK)); 
    }
  }
}

// === ãƒœã‚¿ãƒ³æ©Ÿèƒ½ ===
// ã‚ªãƒ¼ãƒˆãƒ—ãƒ¬ã‚¤åˆ‡ã‚Šæ›¿ãˆ
function toggleAutoPlay() {
  if(game.game_over()) return;
  isAuto = !isAuto;
  
  if(isAuto) {
    // ã‚ªãƒ¼ãƒˆON
    removeHighlights();
    // ãƒ’ãƒ³ãƒˆãƒ»å¾…ã£ãŸãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–
    ui.btnHint.prop('disabled', true).addClass('btn-disabled');
    ui.btnUndo.prop('disabled', true).addClass('btn-disabled');
    ui.btnAuto.addClass('btn-auto-active').text("ğŸ¤– ON");
    
    // ã‚ªãƒ¼ãƒˆé–‹å§‹æ™‚ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
    ui.msg.text(getRandomMsg('autoOn'));

    gameLoop();
  } else {
    // ã‚ªãƒ¼ãƒˆOFF
    ui.btnHint.prop('disabled', false).removeClass('btn-disabled');
    ui.btnUndo.prop('disabled', false).removeClass('btn-disabled');
    ui.btnAuto.removeClass('btn-auto-active').text("ğŸ¤– OFF");
    clearTimeout(autoTimer);
    
    // å†é–‹æ™‚ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
    if (game.turn() === playerColor) {
        ui.msg.text(getRandomMsg('autoResumeMe'));
    } else {
        ui.msg.text(getRandomMsg('autoResumeEnemy'));
    }

    // ç›¸æ‰‹ç•ªãªã‚‰å†é–‹
    if(game.turn() !== playerColor) {
       gameLoop(); 
    }
    updateStatus();
  }
}

// å¾…ã£ãŸæ©Ÿèƒ½
function undoMove() {
  // æ¡ä»¶ï¼šã‚ªãƒ¼ãƒˆã§ãªã„ã€çµ‚äº†ã—ã¦ã„ãªã„ã€è‡ªåˆ†ã®ç•ªã€å±¥æ­´ãŒ2æ‰‹ä»¥ä¸Šã‚ã‚‹
  if(!isAuto && !game.game_over() && game.turn()===playerColor && game.history().length>=2) {
    game.undo(); game.undo(); // 2æ‰‹æˆ»ã™ï¼ˆç›¸æ‰‹ã®æ‰‹ã¨è‡ªåˆ†ã®æ‰‹ï¼‰
    board.position(game.fen()); 
    removeHighlights();
    $('#board .square-55d63').removeClass('highlight-danger-source'); 
    ui.msg.text(getRandomMsg('undo')); 
    updateStatus();
  }
}

// ãƒ’ãƒ³ãƒˆæ©Ÿèƒ½
function showHint() {
  if(game.turn()!==playerColor || isAuto) return;
  ui.msg.text("ãƒ’ãƒ³ãƒˆï¼Ÿ ã—ã‚‡ã†ãŒãªã„ãªã...");
  // å°‘ã—é…ã‚‰ã›ã¦è¡¨ç¤ºï¼ˆè¨ˆç®—ãƒ©ã‚°è€ƒæ…®ï¼‰
  setTimeout(() => {
      const m = getBestMove(3); // å¼·ã•3ã§æ¢ç´¢
      if(m) {
          // ä¸€ç¬å‹•ã‹ã—ã¦åº§æ¨™ã‚’å–å¾—
          const obj = game.move(m); game.undo();
          // ãƒ’ãƒ³ãƒˆè‰²ã§ãƒã‚¤ãƒ©ã‚¤ãƒˆ
          $('#board .square-'+obj.from).addClass('highlight-hint');
          $('#board .square-'+obj.to).addClass('highlight-hint');
          ui.msg.text(getRandomMsg('hint'));
      }
  }, 100);
}

// ãƒã‚¤ãƒ©ã‚¤ãƒˆå…¨æ¶ˆå»
function removeHighlights() {
  $('#board [class*="square"]').removeClass('highlight-move highlight-capture highlight-hint');
}
</script>
</body>
</html>